<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>魔法の割引電卓 - Retail Calc Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            black: '#121212',
                            dark: '#1E1E1E',
                            accent: '#3B82F6', // Blue for keys
                            highlight: '#10B981', // Green for money
                            danger: '#EF4444', // Red for discounts
                        }
                    },
                    boxShadow: {
                        'key': '0 4px 0 0 rgba(0,0,0,0.3)',
                        'key-pressed': '0 1px 0 0 rgba(0,0,0,0.3)',
                    }
                }
            }
        }
    </script>
    <style>
        /* 数字入力時のズーム防止とタップ遅延解消 */
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        /* 電卓特有の沈み込むボタンアニメーション */
        .calc-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 0 rgba(0,0,0,0.3); }
        .calc-btn { transition: all 0.1s ease; }
    </style>
</head>
<body class="bg-brand-black text-white h-[100dvh] flex flex-col overflow-hidden font-sans selection:bg-brand-accent selection:text-white">

    <!-- Header & Mode Switch -->
    <header class="flex justify-between items-center p-4 border-b border-gray-800 bg-brand-dark/50 backdrop-blur-sm z-10">
        <h1 class="text-xs font-bold tracking-widest text-gray-400 uppercase">Retail Calc Pro</h1>
        <!-- 税設定トグル: 元値が税抜か税込か -->
        <div class="flex items-center bg-gray-800 rounded-full p-1 cursor-pointer" onclick="toggleTaxMode()" id="taxToggle">
            <div id="taxExcl" class="px-3 py-1 rounded-full text-xs font-bold bg-brand-accent text-white transition-all">税抜入力</div>
            <div id="taxIncl" class="px-3 py-1 rounded-full text-xs font-bold text-gray-400 transition-all">税込入力</div>
        </div>
    </header>

    <!-- Main Display Area (Information Hierarchy Optimized) -->
    <main class="flex-1 flex flex-col justify-end px-6 py-4 space-y-1 bg-gradient-to-b from-brand-black to-gray-900">
        
        <!-- 元値表示 -->
        <div class="flex justify-between items-end text-gray-500 border-b border-gray-800 pb-2 mb-2">
            <span class="text-xs">定価 (元値)</span>
            <span class="font-mono text-2xl" id="originalPriceDisplay">¥0</span>
        </div>

        <!-- 割引額表示 (お得感の演出) -->
        <div class="flex justify-between items-end text-brand-danger">
            <span class="text-xs font-bold flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 5a3 3 0 015-2.236A3 3 0 0114.83 6H16a2 2 0 110 4h-5V9a1 1 0 10-2 0v1H4a2 2 0 110-4h1.17C5.06 5.687 5 5.35 5 5zm4 1V5a1 1 0 10-1 1h1zm3 0a1 1 0 10-1-1v1h1z" clip-rule="evenodd" /><path d="M9 11H3v5a2 2 0 002 2h4v-7zM11 18h4a2 2 0 002-2v-5h-6v7z" /></svg>
                お得になる金額
            </span>
            <span class="font-mono text-xl font-bold" id="savedAmountDisplay">-¥0</span>
        </div>

        <!-- 最終支払額 (最重要情報) -->
        <div class="flex justify-between items-end text-brand-highlight mt-2">
            <span class="text-sm font-bold bg-brand-highlight/10 px-2 py-1 rounded text-brand-highlight">お支払い税込</span>
            <span class="font-mono text-6xl font-extrabold tracking-tighter" id="finalPriceDisplay">¥0</span>
        </div>
    </main>

    <!-- Control Panel -->
    <section class="bg-gray-900 p-4 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
        
        <!-- Discount Presets -->
        <div class="grid grid-cols-4 gap-3 mb-4">
            <button onclick="setDiscount(10)" class="calc-btn h-14 rounded-xl bg-gray-800 border border-gray-700 text-white font-bold text-lg focus:outline-none focus:ring-2 focus:ring-brand-danger shadow-key active:bg-brand-danger active:border-transparent transition-colors discount-btn group" data-val="10">
                10<span class="text-xs font-normal text-gray-400 group-active:text-white">%OFF</span>
            </button>
            <button onclick="setDiscount(20)" class="calc-btn h-14 rounded-xl bg-gray-800 border border-gray-700 text-white font-bold text-lg focus:outline-none focus:ring-2 focus:ring-brand-danger shadow-key active:bg-brand-danger active:border-transparent transition-colors discount-btn group" data-val="20">
                20<span class="text-xs font-normal text-gray-400 group-active:text-white">%OFF</span>
            </button>
            <button onclick="setDiscount(30)" class="calc-btn h-14 rounded-xl bg-gray-800 border border-gray-700 text-white font-bold text-lg focus:outline-none focus:ring-2 focus:ring-brand-danger shadow-key active:bg-brand-danger active:border-transparent transition-colors discount-btn group" data-val="30">
                30<span class="text-xs font-normal text-gray-400 group-active:text-white">%OFF</span>
            </button>
            <button onclick="setDiscount(50)" class="calc-btn h-14 rounded-xl bg-brand-danger border border-red-600 text-white font-bold text-xl focus:outline-none shadow-key active:bg-red-600 discount-btn" data-val="50">
                50<span class="text-xs font-normal">%OFF</span>
            </button>
        </div>

        <!-- Numeric Keypad -->
        <div class="grid grid-cols-4 gap-3">
            <button onclick="appendNumber('7')" class="calc-btn h-16 rounded-2xl bg-gray-800 text-2xl font-mono font-medium shadow-key text-white">7</button>
            <button onclick="appendNumber('8')" class="calc-btn h-16 rounded-2xl bg-gray-800 text-2xl font-mono font-medium shadow-key text-white">8</button>
            <button onclick="appendNumber('9')" class="calc-btn h-16 rounded-2xl bg-gray-800 text-2xl font-mono font-medium shadow-key text-white">9</button>
            <button onclick="clearAll()" class="calc-btn h-16 rounded-2xl bg-gray-700 text-xl font-bold text-red-400 shadow-key">AC</button>

            <button onclick="appendNumber('4')" class="calc-btn h-16 rounded-2xl bg-gray-800 text-2xl font-mono font-medium shadow-key text-white">4</button>
            <button onclick="appendNumber('5')" class="calc-btn h-16 rounded-2xl bg-gray-800 text-2xl font-mono font-medium shadow-key text-white">5</button>
            <button onclick="appendNumber('6')" class="calc-btn h-16 rounded-2xl bg-gray-800 text-2xl font-mono font-medium shadow-key text-white">6</button>
            <button onclick="backspace()" class="calc-btn h-16 rounded-2xl bg-gray-700 text-xl shadow-key flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z" /></svg>
            </button>

            <button onclick="appendNumber('1')" class="calc-btn h-16 rounded-2xl bg-gray-800 text-2xl font-mono font-medium shadow-key text-white">1</button>
            <button onclick="appendNumber('2')" class="calc-btn h-16 rounded-2xl bg-gray-800 text-2xl font-mono font-medium shadow-key text-white">2</button>
            <button onclick="appendNumber('3')" class="calc-btn h-16 rounded-2xl bg-gray-800 text-2xl font-mono font-medium shadow-key text-white">3</button>
            <!-- 0と00をまとめる -->
            <button onclick="appendNumber('0')" class="calc-btn h-16 rounded-2xl bg-gray-800 text-2xl font-mono font-medium shadow-key text-white row-span-2 flex items-center justify-center">0</button>
            
            <button onclick="appendNumber('00')" class="calc-btn h-16 rounded-2xl bg-gray-800 text-xl font-mono font-medium shadow-key text-white col-span-3">00</button>
        </div>
    </section>

    <script>
        // State
        let currentInput = '0';
        let currentDiscount = 0;
        let isTaxExcludedInput = true; // Default: 税抜価格を入力するモード

        // DOM Elements
        const els = {
            original: document.getElementById('originalPriceDisplay'),
            saved: document.getElementById('savedAmountDisplay'),
            final: document.getElementById('finalPriceDisplay'),
            discountBtns: document.querySelectorAll('.discount-btn'),
            taxExcl: document.getElementById('taxExcl'),
            taxIncl: document.getElementById('taxIncl'),
        };

        // Formatter
        const formatter = new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' });

        // Logic
        function updateDisplay() {
            const rawPrice = parseInt(currentInput, 10);
            
            // 入力が0の場合はリセット表示
            if (isNaN(rawPrice) || rawPrice === 0) {
                els.original.textContent = '¥0';
                els.saved.textContent = '-¥0';
                els.final.textContent = '¥0';
                els.saved.classList.remove('animate-pulse');
                return;
            }

            // 計算ロジック
            // 1. 元値の税抜価格を特定する
            let basePriceExclTax = 0;
            let originalPriceForDisplay = 0;

            if (isTaxExcludedInput) {
                basePriceExclTax = rawPrice;
                originalPriceForDisplay = rawPrice; // 表示は入力値そのまま（税抜）
            } else {
                basePriceExclTax = rawPrice / 1.1; // 税込から税抜へ戻す
                originalPriceForDisplay = rawPrice; // 表示は入力値そのまま（税込）
            }

            // 2. 割引後の価格を計算 (通常、割引は税抜価格に対して適用されることが多いが、
            //    簡便のため「販売価格(税込/税抜問わず)からX%引く」という運用も多い。
            //    ここでは厳密に「税抜価格」に対して割引を適用し、最後に税をかける方式を採用。
            //    (入力が税込の場合は、税込価格からそのまま引く方が客感覚に近いが、
            //     レジ処理と合わせるため税抜ベースで計算)
            
            const discountedPriceExclTax = basePriceExclTax * (1 - (currentDiscount / 100));
            
            // 3. 最終税込価格 (切り捨て)
            const finalPriceInclTax = Math.floor(discountedPriceExclTax * 1.1);
            
            // 4. お得額 (元値(税込相当) - 最終支払額)
            // 元値が税抜入力なら、比較対象は 元値*1.1
            const originalPriceInclTax = isTaxExcludedInput ? Math.floor(rawPrice * 1.1) : rawPrice;
            const savedAmount = originalPriceInclTax - finalPriceInclTax;

            // 表示更新
            els.original.textContent = formatter.format(rawPrice);
            els.saved.textContent = '-' + formatter.format(savedAmount);
            els.final.textContent = formatter.format(finalPriceInclTax);

            // 割引が適用されている場合、お得額を強調
            if (currentDiscount > 0) {
                els.saved.parentElement.classList.remove('opacity-0');
            }
        }

        function appendNumber(num) {
            // 最大桁数制限 (レイアウト崩れ防止と常識的な価格範囲)
            if (currentInput.length > 8) return;

            if (currentInput === '0') {
                if (num === '00') return; // 最初から00は入れさせない
                currentInput = num;
            } else {
                currentInput += num;
            }
            triggerHaptic();
            updateDisplay();
        }

        function backspace() {
            if (currentInput.length === 1) {
                currentInput = '0';
            } else {
                currentInput = currentInput.slice(0, -1);
            }
            triggerHaptic();
            updateDisplay();
        }

        function clearAll() {
            currentInput = '0';
            currentDiscount = 0;
            resetDiscountButtons();
            triggerHaptic();
            updateDisplay();
        }

        function setDiscount(percent) {
            // 同じボタンを押したら解除するトグル機能
            if (currentDiscount === percent) {
                currentDiscount = 0;
                resetDiscountButtons();
            } else {
                currentDiscount = percent;
                updateButtons(percent);
            }
            triggerHaptic();
            updateDisplay();
        }

        function toggleTaxMode() {
            isTaxExcludedInput = !isTaxExcludedInput;
            if (isTaxExcludedInput) {
                els.taxExcl.classList.replace('text-gray-400', 'text-white');
                els.taxExcl.classList.add('bg-brand-accent');
                els.taxIncl.classList.replace('text-white', 'text-gray-400');
                els.taxIncl.classList.remove('bg-brand-accent');
            } else {
                els.taxIncl.classList.replace('text-gray-400', 'text-white');
                els.taxIncl.classList.add('bg-brand-accent');
                els.taxExcl.classList.replace('text-white', 'text-gray-400');
                els.taxExcl.classList.remove('bg-brand-accent');
            }
            triggerHaptic();
            updateDisplay(); // 再計算
        }

        // UI Utilities
        function updateButtons(activeVal) {
            els.discountBtns.forEach(btn => {
                const val = parseInt(btn.dataset.val);
                if (val === activeVal) {
                    btn.classList.add('ring-2', 'ring-white', 'scale-105');
                    if(val !== 50) btn.classList.add('bg-brand-danger'); // 50以外も赤くする
                } else {
                    btn.classList.remove('ring-2', 'ring-white', 'scale-105');
                    if(val !== 50) btn.classList.remove('bg-brand-danger');
                }
            });
        }

        function resetDiscountButtons() {
            els.discountBtns.forEach(btn => {
                btn.classList.remove('ring-2', 'ring-white', 'scale-105');
                const val = parseInt(btn.dataset.val);
                if(val !== 50) btn.classList.remove('bg-brand-danger');
            });
        }

        function triggerHaptic() {
            // スマホでの操作感を向上させるバイブレーション（対応機種のみ）
            if (navigator.vibrate) {
                navigator.vibrate(5);
            }
        }
        
        // Init
        updateDisplay();
    </script>
</body>
</html>
