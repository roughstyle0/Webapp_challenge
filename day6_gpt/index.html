<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚µãƒ³ã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* ç´™ã£ã½ã„è³ªæ„Ÿï¼ˆä¿å­˜ç”»åƒã§ã‚‚ç¶ºéº—ï¼‰ */
    .paper {
      background-image:
        radial-gradient(1200px 600px at 20% 0%, rgba(255,255,255,.7), rgba(255,255,255,0)),
        radial-gradient(900px 500px at 90% 10%, rgba(255,255,255,.55), rgba(255,255,255,0)),
        radial-gradient(1200px 900px at 50% 100%, rgba(0,0,0,.06), rgba(0,0,0,0));
      background-blend-mode: overlay;
    }
    .grain { position: relative; overflow: hidden; }
    .grain::after{
      content:"";
      position:absolute; inset:-50%;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E");
      transform: rotate(6deg);
      pointer-events:none;
      mix-blend-mode:multiply;
      opacity:.22;
    }
    .shine { position: relative; }
    .shine::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(115deg, rgba(255,255,255,.25), rgba(255,255,255,0) 35%, rgba(255,255,255,.18) 55%, rgba(255,255,255,0) 75%);
      pointer-events:none;
      opacity:.8;
    }
    .card-shadow { box-shadow: 0 22px 50px rgba(0,0,0,.12), 0 10px 18px rgba(0,0,0,.08); }
    .wrap { white-space: pre-wrap; word-break: break-word; }
    .invalid { outline: 2px solid rgba(239,68,68,.8); outline-offset: 2px; }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['ui-sans-serif', 'system-ui', 'Hiragino Kaku Gothic ProN', 'Meiryo', 'sans-serif'],
          }
        }
      }
    }
  </script>
</head>

<body class="min-h-screen bg-gradient-to-b from-rose-50 via-amber-50 to-sky-50 text-slate-800">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/60 border-b border-white/40">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-rose-400 to-amber-300 grid place-items-center shadow-sm">
        <span class="text-white text-lg">ğŸ’Œ</span>
      </div>
      <div class="min-w-0">
        <h1 class="text-base sm:text-lg font-bold tracking-tight truncate">ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚µãƒ³ã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
        <p class="text-xs sm:text-sm text-slate-600 truncate">LINEã‚„ãƒãƒ£ãƒƒãƒˆã§ã€Œã¡ã‚ƒã‚“ã¨ä¼ã‚ã‚‹ã€æ„Ÿè¬ã‚«ãƒ¼ãƒ‰ã‚’ä¸€ç¬ã§ã€‚</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <!-- âœ… iPhoneã§ã‚‚è¡¨ç¤º -->
        <button id="btnFillExample" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/70 hover:bg-white border border-white/70 shadow-sm text-sm">
          <span>âœ¨</span><span>ä¾‹ã‚’å…¥ã‚Œã‚‹</span>
        </button>
        <button id="btnReset" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/70 hover:bg-white border border-white/70 shadow-sm text-sm">
          <span>â†º</span><span>ãƒªã‚»ãƒƒãƒˆ</span>
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6 sm:py-10 grid gap-6 lg:grid-cols-2 lg:gap-10">
    <!-- Form -->
    <section class="order-2 lg:order-1">
      <div class="rounded-3xl bg-white/70 border border-white/70 shadow-sm p-4 sm:p-6">
        <h2 class="text-lg font-bold">å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h2>
        <p class="text-sm text-slate-600 mt-1">å…¥åŠ›ã—ãŸå†…å®¹ãŒå³ã®ã‚«ãƒ¼ãƒ‰ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ ã•ã‚Œã¾ã™ã€‚</p>

        <div class="mt-6 grid gap-4">
          <div>
            <label class="text-sm font-semibold">å®›å</label>
            <div class="mt-2 flex items-center gap-2">
              <input id="toName" type="text" maxlength="18"
                class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-200"
                placeholder="ä¾‹ï¼‰ä½è—¤ã•ã‚“" autocomplete="off" />
              <span class="text-xs text-slate-500 shrink-0">ã¸</span>
            </div>
            <p class="mt-1 text-xs text-slate-500">é•·ãã¦ã‚‚è‡ªå‹•ã§ç¸®å°ã—ã¾ã™ï¼ˆæœ€å¤§18æ–‡å­—ï¼‰ã€‚</p>
          </div>

          <div>
            <label class="text-sm font-semibold">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚«ãƒ†ã‚´ãƒª</label>
            <div class="mt-2">
              <select id="category"
                class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-200">
              </select>
            </div>
            <p class="mt-1 text-xs text-slate-500">ã‚«ãƒ†ã‚´ãƒªã§èƒŒæ™¯è‰²ãƒ»ã‚¤ãƒ©ã‚¹ãƒˆãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</p>
          </div>

          <div>
            <label class="text-sm font-semibold">è‡ªç”±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆçŸ­ã‚ï¼‰</label>
            <div class="mt-2">
              <textarea id="message" rows="4" maxlength="160"
                class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-200"
                placeholder="ä¾‹ï¼‰å¿™ã—ã„æ™‚é–“å¸¯ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã‚Œã¦æœ¬å½“ã«åŠ©ã‹ã£ãŸï¼ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ï¼"></textarea>
            </div>
            <div class="mt-1 flex items-center justify-between text-xs text-slate-500">
              <span>æ”¹è¡ŒOKã€‚å…·ä½“çš„ã«æ›¸ãã¨åˆºã•ã‚Šã¾ã™ã€‚</span>
              <span><span id="msgCount">0</span>/160</span>
            </div>
          </div>

          <div>
            <label class="text-sm font-semibold">è´ˆã‚Šä¸»</label>
            <div class="mt-2 flex items-center gap-2">
              <input id="fromName" type="text" maxlength="18"
                class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-200"
                placeholder="ä¾‹ï¼‰åº—é•· ç”°ä¸­" autocomplete="off" />
              <span class="text-xs text-slate-500 shrink-0">ã‚ˆã‚Š</span>
            </div>
          </div>
        </div>

        <div class="mt-6 flex flex-col sm:flex-row gap-3 sm:items-center">
          <button id="btnDownload"
            class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl bg-gradient-to-r from-rose-500 to-amber-400 text-white font-semibold shadow-md hover:shadow-lg active:scale-[0.99] transition">
            <span>â¬‡ï¸</span>
            <span>ç”»åƒã¨ã—ã¦ä¿å­˜</span>
          </button>

          <div class="flex-1 rounded-2xl bg-white/70 border border-white/70 px-4 py-3 text-xs text-slate-600">
            <p class="font-semibold">iPhoneã®ä¿å­˜æ–¹æ³•</p>
            <ul class="list-disc pl-5 mt-1 space-y-1">
              <li>å¯¾å¿œã—ã¦ã„ã‚Œã°ã€Œå…±æœ‰ã€â†’ã€Œå†™çœŸã«ä¿å­˜ã€</li>
              <li>ãƒ€ãƒ¡ãªã‚‰ç”»åƒã‚’æ–°è¦ã‚¿ãƒ–ã«è¡¨ç¤ºâ†’é•·æŠ¼ã—ä¿å­˜</li>
            </ul>
          </div>
        </div>

        <div id="toast" class="pointer-events-none mt-4 hidden">
          <div class="rounded-2xl bg-slate-900 text-white px-4 py-3 text-sm shadow-lg inline-flex items-center gap-2">
            <span id="toastIcon">âœ…</span>
            <span id="toastMsg">ä¿å­˜ã—ã¾ã—ãŸ</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Preview -->
    <section class="order-1 lg:order-2">
      <div class="lg:sticky lg:top-24">
        <div class="flex items-end justify-between gap-3 mb-3">
          <div>
            <h2 class="text-lg font-bold">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <p class="text-sm text-slate-600">ãã®ã¾ã¾é€ã‚Œã‚‹â€œã¡ã‚‡ã†ã©ã„ã„ã‚µã‚¤ã‚ºæ„Ÿâ€ã€‚</p>
          </div>
          <div class="text-xs text-slate-500">æ¨å¥¨ï¼šã‚¹ãƒãƒ›ã§ä¿å­˜â†’LINEé€ä¿¡</div>
        </div>

        <div class="grid place-items-center">
          <div id="cardWrap" class="w-full max-w-[520px]">
            <div id="card"
              class="grain shine paper card-shadow rounded-[28px] border border-white/60 p-6 sm:p-8 relative select-none"
              style="background: linear-gradient(135deg, #ffe4e6, #fff7ed);">

              <div class="absolute -top-3 -right-3 h-16 w-16 rounded-3xl bg-white/50 blur-[1px]"></div>
              <div class="absolute -bottom-4 -left-4 h-20 w-20 rounded-3xl bg-white/40 blur-[1px]"></div>

              <div class="flex items-start justify-between gap-4">
                <div class="min-w-0">
                  <div class="text-xs sm:text-sm text-slate-700/80">To:</div>
                  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯è¦‹åˆ‡ã‚Œé˜²æ­¢ã®ãŸã‚ truncate ã‚’ä»˜ã‘ãªã„ï¼ˆä¿å­˜æ™‚ã‚‚å®‰å…¨ï¼‰ -->
                  <div id="cardTo" class="text-xl sm:text-2xl font-extrabold tracking-tight">ã€‡ã€‡ã•ã‚“ã¸</div>
                </div>
                <div class="shrink-0 text-right">
                  <div class="text-3xl sm:text-4xl" id="cardIcon">ğŸ’–</div>
                  <div id="cardBadge"
                       class="mt-2 inline-flex items-center px-3 py-1 rounded-full bg-white/70 border border-white/70 text-xs font-semibold">
                    ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†
                  </div>
                </div>
              </div>

              <div class="mt-6 sm:mt-7">
                <div class="text-xs sm:text-sm text-slate-700/80">Message:</div>
                <div id="cardMessage"
                     class="wrap mt-2 text-[15px] sm:text-base leading-relaxed font-medium text-slate-800">
                  ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚çŸ­ãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚ã‚ãªãŸã®ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¯ã€ã¡ã‚ƒã‚“ã¨å±Šãã¾ã™ã€‚
                </div>
              </div>

              <div class="mt-6 sm:mt-7 h-px bg-white/70"></div>

              <div class="mt-5 flex items-end justify-between gap-3">
                <div class="text-xs sm:text-sm text-slate-700/80">
                  <div class="font-semibold">From:</div>
                  <div id="cardFrom" class="mt-1 text-sm sm:text-base font-bold">ã€‡ã€‡ã‚ˆã‚Š</div>
                </div>

                <div class="text-right">
                  <div class="text-xs text-slate-700/70">#ThanksCard</div>
                  <div class="mt-1 text-xs text-slate-700/70" id="cardDate"></div>
                </div>
              </div>

              <div id="exportNote" class="mt-4 text-[11px] text-slate-700/60">
                â€» ä¿å­˜ç”¨ç”»åƒã«ã¯ã“ã®æ³¨è¨˜ã¯å…¥ã‚Šã¾ã›ã‚“
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4 text-xs text-slate-600">
          <span class="font-semibold">é€ã‚‹å‰ã®ä¸€è¨€ä¾‹ï¼š</span>
          ã€Œä»Šæ—¥åŠ©ã‹ã£ãŸï¼ã¡ã‚‡ã£ã¨ã‚«ãƒ¼ãƒ‰ä½œã£ãŸã‹ã‚‰å—ã‘å–ã£ã¦ã€œã€
        </div>
      </div>
    </section>
  </main>

  <footer class="pb-10">
    <div class="mx-auto max-w-6xl px-4 text-xs text-slate-500">
      <p>Â© Thanks Card Generator / 1ãƒ•ã‚¡ã‚¤ãƒ«å®Œçµãƒ»å¤–éƒ¨ã‚µãƒ¼ãƒä¸è¦</p>
    </div>
  </footer>

  <script>
    // ===== Data =====
    const CATEGORIES = [
      { key: "help",     label: "ãƒ˜ãƒ«ãƒ—æ„Ÿè¬ï¼",       icon: "ğŸ«¶", gradient: ["#dbeafe","#fff7ed"], accent:"#3b82f6",
        defaultMsg:"å¿™ã—ã„æ™‚é–“å¸¯ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã‚Œã¦æœ¬å½“ã«åŠ©ã‹ã£ãŸï¼ã‚ã‚ŠãŒã¨ã†ï¼" },
      { key: "service",  label: "ç´ æ™´ã‚‰ã—ã„æ¥å®¢ï¼",   icon: "ğŸŒŸ", gradient: ["#fef9c3","#ffe4e6"], accent:"#f59e0b",
        defaultMsg:"ãŠå®¢æ§˜ã¸ã®å£°ã‹ã‘ãŒã™ã”ãä¸å¯§ã§ã€è¦‹ã¦ã„ã¦æ°—æŒã¡ã‚ˆã‹ã£ãŸï¼" },
      { key: "birthday", label: "èª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ï¼", icon: "ğŸ‚", gradient: ["#fae8ff","#e0f2fe"], accent:"#a855f7",
        defaultMsg:"ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ï¼ç´ æ•µãªä¸€å¹´ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ï¼" },
      { key: "always",   label: "ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†",   icon: "ğŸ’–", gradient: ["#ffe4e6","#fff7ed"], accent:"#ec4899",
        defaultMsg:"ã„ã¤ã‚‚æ”¯ãˆã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ã™ã”ãé ¼ã‚Šã«ã—ã¦ã„ã¾ã™ï¼" },
      { key: "team",     label: "ãƒãƒ¼ãƒ æœ€é«˜ï¼",       icon: "ğŸ¤", gradient: ["#dcfce7","#ecfeff"], accent:"#22c55e",
        defaultMsg:"ã¿ã‚“ãªã®é›°å›²æ°—ã‚’æ˜ã‚‹ãã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼" }
    ];

    const $ = (id) => document.getElementById(id);

    // ===== Helpers =====
    function todayJP() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}/${mm}/${dd}`;
    }

    function showToast(message, icon = "âœ…") {
      const toast = $("toast");
      $("toastMsg").textContent = message;
      $("toastIcon").textContent = icon;
      toast.classList.remove("hidden");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.add("hidden"), 2400);
    }

    function hexToRgba(hex, a) {
      const h = hex.replace("#", "").trim();
      const full = h.length === 3 ? h.split("").map(ch => ch + ch).join("") : h;
      const num = parseInt(full, 16);
      const r = (num >> 16) & 255;
      const g = (num >> 8) & 255;
      const b = num & 255;
      return `rgba(${r},${g},${b},${a})`;
    }

    function sanitizeSingleLine(str) { return (str || "").replace(/\s+/g, " ").trim(); }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    // æ±ç”¨ï¼šè¦ç´ ãŒåã¾ã‚‹ã¾ã§ãƒ•ã‚©ãƒ³ãƒˆã‚’ç¸®å°ï¼ˆ1è¡Œ/è¤‡æ•°è¡Œã©ã¡ã‚‰ã‚‚OKï¼‰
    function fitText(el, { min = 12, max = 28, step = 1, mode = "width", maxHeightPx = null } = {}) {
      if (!el) return;
      el.style.fontSize = max + "px";
      el.style.lineHeight = "1.25";

      const check = () => {
        const overW = el.scrollWidth > el.clientWidth + 1;
        const overH = maxHeightPx != null ? (el.scrollHeight > maxHeightPx + 1) : (el.scrollHeight > el.clientHeight + 1);
        return mode === "width" ? overW : (mode === "height" ? overH : (overW || overH));
      };

      let size = max;
      let safety = 60;
      while (safety-- > 0 && check() && size > min) {
        size -= step;
        el.style.fontSize = size + "px";
      }
    }

    function setCardTheme(catKey) {
      const c = CATEGORIES.find(x => x.key === catKey) || CATEGORIES[0];
      $("card").style.background = `linear-gradient(135deg, ${c.gradient[0]}, ${c.gradient[1]})`;
      $("cardIcon").textContent = c.icon;
      $("cardBadge").textContent = c.label;
      $("cardBadge").style.boxShadow = `0 10px 20px ${hexToRgba(c.accent, 0.18)}`;
      $("cardBadge").style.borderColor = hexToRgba(c.accent, 0.18);
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é ˜åŸŸã¯ã€Œä¸€å®šè¡Œæ•°ã«åã‚ã‚‹ã€ï¼‹è‡ªå‹•ç¸®å°
    function applyMessageClampAndFit() {
      const area = $("cardMessage");
      if (!area) return;

      const maxLines = window.matchMedia("(min-width: 640px)").matches ? 6 : 5;
      const basePx = window.matchMedia("(min-width: 640px)").matches ? 16 : 15;

      area.style.maxHeight = `calc(${maxLines} * 1.6em)`;
      area.style.overflow = "hidden";

      // ã¾ãšåŸºæº–ã‚µã‚¤ã‚ºã«æˆ»ã—ã¦ã‹ã‚‰ç¸®å°
      area.style.fontSize = basePx + "px";
      area.style.lineHeight = "1.6";

      // é«˜ã•ã«åã¾ã‚‹ã¾ã§ç¸®å°
      let size = basePx;
      let safety = 40;
      while (safety-- > 0 && area.scrollHeight > area.clientHeight + 2 && size > 13) {
        size -= 1;
        area.style.fontSize = size + "px";
      }
    }

    // å®›åãƒ»è´ˆã‚Šä¸»ã‚’å¹…ã«åˆã‚ã›ã¦è‡ªå‹•ç¸®å°
    function applyHeaderFooterFit() {
      const toEl = $("cardTo");
      const fromEl = $("cardFrom");

      // To: ã¯å³å´ã«ã‚¢ã‚¤ã‚³ãƒ³/ãƒãƒƒã‚¸ãŒã‚ã‚‹ã®ã§ã€å·¦å´æ å†…ã«åã‚ã‚‹ï¼ˆmin-w-0ã§åŠ¹ãï¼‰
      if (toEl) {
        toEl.style.whiteSpace = "normal";
        toEl.style.overflow = "hidden";
        toEl.style.textOverflow = "clip";
        // smä»¥ä¸Šã¯28pxç›®å®‰ã€ãã‚Œä»¥å¤–ã¯22pxç›®å®‰
        const maxPx = window.matchMedia("(min-width: 640px)").matches ? 28 : 22;
        fitText(toEl, { min: 14, max: maxPx, step: 1, mode: "width" });
      }

      if (fromEl) {
        fromEl.style.whiteSpace = "normal";
        fromEl.style.overflow = "hidden";
        const maxPx = window.matchMedia("(min-width: 640px)").matches ? 16 : 15;
        fitText(fromEl, { min: 12, max: maxPx, step: 1, mode: "width" });
      }
    }

    function updatePreview() {
      const to = sanitizeSingleLine($("toName").value);
      const from = sanitizeSingleLine($("fromName").value);
      const msg = ($("message").value || "").trim();
      const cat = $("category").value;

      setCardTheme(cat);
      $("msgCount").textContent = String(msg.length);

      $("cardTo").textContent = (to ? `${to}ã¸` : "ã€‡ã€‡ã•ã‚“ã¸");
      $("cardFrom").textContent = (from ? `${from}ã‚ˆã‚Š` : "ã€‡ã€‡ã‚ˆã‚Š");
      $("cardMessage").textContent =
        msg || "ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚çŸ­ãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚ã‚ãªãŸã®ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¯ã€ã¡ã‚ƒã‚“ã¨å±Šãã¾ã™ã€‚";
      $("cardDate").textContent = todayJP();

      // è‡ªå‹•ç¸®å°ç³»
      applyHeaderFooterFit();
      applyMessageClampAndFit();
    }

    function validateForSave() {
      const toEl = $("toName");
      const fromEl = $("fromName");
      const msgEl = $("message");
      [toEl, fromEl, msgEl].forEach(el => el.classList.remove("invalid"));

      const to = sanitizeSingleLine(toEl.value);
      const from = sanitizeSingleLine(fromEl.value);
      const msg = (msgEl.value || "").trim();

      let ok = true;
      if (!to) { toEl.classList.add("invalid"); ok = false; }
      if (!from) { fromEl.classList.add("invalid"); ok = false; }
      if (!msg) { msgEl.classList.add("invalid"); ok = false; }

      if (!ok) showToast("å®›åãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»è´ˆã‚Šä¸»ã‚’å…¥ã‚Œã‚‹ã¨ã€ã‚‚ã£ã¨å¬‰ã—ã„ã‚«ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ï¼", "âš ï¸");
      return ok;
    }

    function filenameSafe() {
      const safeTo = sanitizeSingleLine($("toName").value).replace(/[\\/:*?"<>|]/g, "");
      const stamp = todayJP().replaceAll("/", "");
      return `thanks-card_${safeTo || "card"}_${stamp}.png`;
    }

    // ===== Export: å®‰å®šåŒ–ã®è‚ï¼ˆä¿å­˜ç”¨ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œã£ã¦æ’®ã‚‹ï¼‰ =====
    function buildExportClone() {
      const original = $("card");
      const clone = original.cloneNode(true);

      // æ³¨è¨˜å‰Šé™¤
      const note = clone.querySelector("#exportNote");
      if (note) note.remove();

      // âœ… ä¿å­˜æ™‚ã¯ã€Œåˆ‡ã‚‰ãªã„ã€æ–¹é‡ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åˆ¶é™è§£é™¤
      const msg = clone.querySelector("#cardMessage");
      if (msg) {
        msg.style.maxHeight = "none";
        msg.style.overflow = "visible";
        msg.style.whiteSpace = "pre-wrap";
        msg.style.wordBreak = "break-word";
      }

      // To/Fromã‚‚ç¢ºå®Ÿã«åˆ‡ã‚‰ãªã„ï¼ˆãŸã ã—åã¾ã‚Šå„ªå…ˆã§è‡ªå‹•ç¸®å°ï¼‰
      const to = clone.querySelector("#cardTo");
      if (to) {
        to.style.whiteSpace = "normal";
        to.style.overflow = "visible";
        to.style.textOverflow = "clip";
      }
      const from = clone.querySelector("#cardFrom");
      if (from) {
        from.style.whiteSpace = "normal";
        from.style.overflow = "visible";
      }

      // ä¿å­˜å°‚ç”¨ã®å›ºå®šå¹…ã‚³ãƒ³ãƒ†ãƒŠ
      const wrapper = document.createElement("div");
      wrapper.style.position = "fixed";
      wrapper.style.left = "-99999px";
      wrapper.style.top = "0";
      wrapper.style.width = "1080px";
      wrapper.style.padding = "0";
      wrapper.style.margin = "0";
      wrapper.style.zIndex = "-1";

      clone.style.width = "1080px";
      clone.style.maxWidth = "1080px";

      wrapper.appendChild(clone);
      document.body.appendChild(wrapper);

      // ã‚¯ãƒ­ãƒ¼ãƒ³å´ã«ã‚‚è‡ªå‹•ç¸®å°ã‚’é©ç”¨ï¼ˆä¿å­˜ç”¨ã«æœ€é©åŒ–ï¼‰
      // ã“ã“ã¯ã€Œcloneå†…ã®è¦ç´ ã€ã«å¯¾ã—ã¦è¡Œã†
      const cloneTo = clone.querySelector("#cardTo");
      const cloneFrom = clone.querySelector("#cardFrom");
      const cloneMsg = clone.querySelector("#cardMessage");

      // ã‚¯ãƒ­ãƒ¼ãƒ³ã¯å›ºå®šå¹…ãªã®ã§ã€å¹…åŸºæº–ã§ç¸®å°ãŒå®‰å®š
      // Toã¯2è¡Œã¾ã§è¨±å¯ã—ã¤ã¤ã€æº¢ã‚Œã‚‹ãªã‚‰ç¸®å°
      if (cloneTo) {
        cloneTo.style.lineHeight = "1.15";
        // clientWidthãŒå–ã‚Œã‚‹ã‚ˆã†ã«è»½ãã‚¹ã‚¿ã‚¤ãƒ«ç¢ºå®š
        // ï¼ˆå¾Œã§rafå¾…ã¡ã‚‚å…¥ã‚Œã‚‹ï¼‰
      }
      if (cloneFrom) {
        cloneFrom.style.lineHeight = "1.25";
      }
      if (cloneMsg) {
        cloneMsg.style.lineHeight = "1.6";
      }

      return { wrapper, clone };
    }

    function fitCloneTexts(clone) {
      // ä¿å­˜ç”¨ã®è‡ªå‹•ç¸®å°ï¼ˆTo/From/Messageå…¨éƒ¨ï¼‰
      const cloneTo = clone.querySelector("#cardTo");
      const cloneFrom = clone.querySelector("#cardFrom");
      const cloneMsg = clone.querySelector("#cardMessage");

      if (cloneTo) {
        const maxPx = 54;    // 1080pxå¹…ãªã‚‰ã“ã‚Œãã‚‰ã„ãŒâ€œè¦‹æ „ãˆè‰¯ã„â€
        // Toã®é ˜åŸŸã¯ã€Œå·¦ãƒ–ãƒ­ãƒƒã‚¯ã€ãªã®ã§ã€æ¨ªå¹…ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã« rightãƒ–ãƒ­ãƒƒã‚¯ã®å¹…åˆ†å·®ã—å¼•ã‹ã‚Œã¦ã„ã‚‹ãŒã€
        // flexã§è‡ªç„¶ã«æ±ºã¾ã‚‹ã®ã§ã€ã“ã“ã¯ width-fit ã§OK
        fitText(cloneTo, { min: 28, max: maxPx, step: 1, mode: "width" });

        // ã•ã‚‰ã«ã€Œé«˜ã•ã€ãŒå¢—ãˆã™ããŸå ´åˆï¼ˆ3è¡Œä»¥ä¸Šã«ãªã‚Šãã†ï¼‰ã«ç¸®å°
        // ç›®å®‰ï¼š2è¡Œåˆ†ã¾ã§
        const line = parseFloat(getComputedStyle(cloneTo).lineHeight) || 60;
        const maxH = line * 2.15;
        let size = parseFloat(getComputedStyle(cloneTo).fontSize) || maxPx;
        let safety = 40;
        while (safety-- > 0 && cloneTo.scrollHeight > maxH && size > 22) {
          size -= 1;
          cloneTo.style.fontSize = size + "px";
        }
      }

      if (cloneFrom) {
        fitText(cloneFrom, { min: 22, max: 34, step: 1, mode: "width" });
      }

      if (cloneMsg) {
        // ä¿å­˜æ™‚ã¯åˆ‡ã‚‰ãªã„ã‘ã©ã€èª­ã¿ã‚„ã™ã„ç¯„å›²ã§ç¸®å°ã—ã¦â€œé•·æ–‡å´©å£Šâ€ã‚’é˜²ã
        // ç›®å®‰ï¼šæœ€å¤§ãƒ•ã‚©ãƒ³ãƒˆ 32px ç›¸å½“ï¼ˆå›ºå®šå¹…ã®ãŸã‚ï¼‰
        let max = 32;
        let min = 22;
        cloneMsg.style.fontSize = max + "px";
        cloneMsg.style.lineHeight = "1.6";

        // ã€Œã‚«ãƒ¼ãƒ‰å†…ã§ã®è¦–è¦šãƒãƒ©ãƒ³ã‚¹ã€ç”¨ã®ä¸Šé™é«˜ã•ï¼ˆã ã„ãŸã„ã‚«ãƒ¼ãƒ‰ä¸­å¤®ã€œä¸‹ã«åã¾ã‚‹ç¨‹åº¦ï¼‰
        // å®Ÿæ¸¬ã«ä¾å­˜ã—ãªã„ã‚ˆã†ã€ã‚«ãƒ¼ãƒ‰å…¨ä½“ã®é«˜ã•å‰²åˆã§åˆ¶é™
        const card = clone;
        const cardH = card.getBoundingClientRect().height || 1200;
        const allowed = cardH * 0.42; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é ˜åŸŸã¯ã‚«ãƒ¼ãƒ‰ã®ç´„42%ã¾ã§
        let size = max;
        let safety = 60;
        while (safety-- > 0 && cloneMsg.scrollHeight > allowed && size > min) {
          size -= 1;
          cloneMsg.style.fontSize = size + "px";
        }
      }
    }

    async function downloadCard() {
      if (!validateForSave()) return;

      let wrapper, clone;
      try {
        ({ wrapper, clone } = buildExportClone());

        // iOSã§é‡è¦ï¼šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ&ãƒ•ã‚©ãƒ³ãƒˆåæ˜ å¾…ã¡
        await sleep(50);
        await new Promise(requestAnimationFrame);
        await new Promise(requestAnimationFrame);

        // ä¿å­˜ç”¨ã®è‡ªå‹•ç¸®å°ã‚’ç¢ºå®š
        fitCloneTexts(clone);

        // ã•ã‚‰ã«1ãƒ•ãƒ¬ãƒ¼ãƒ å¾…ã£ã¦ç¢ºå®Ÿã«åæ˜ 
        await new Promise(requestAnimationFrame);

        // iOSã¯ scale ä¸Šã’ã™ãã‚‹ã¨ä¸å®‰å®šã«ãªã‚Šã‚„ã™ã„
        const scale = Math.min(2.5, Math.max(2, (window.devicePixelRatio || 2)));

        const canvas = await html2canvas(clone, {
          backgroundColor: null,
          scale,
          useCORS: true,
          logging: false,
          windowWidth: 1080,
          width: 1080,
          scrollX: 0,
          scrollY: 0
        });

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
        if (!blob) throw new Error("toBlob failed");

        const file = new File([blob], filenameSafe(), { type: "image/png" });

        // A) å…±æœ‰ãŒä½¿ãˆã‚‹ãªã‚‰æœ€å„ªå…ˆï¼ˆiPhoneã§å†™çœŸã«ä¿å­˜ã—ã‚„ã™ã„ï¼‰
        if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
          await navigator.share({ files: [file], title: "Thanks Card" });
          showToast("å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã¾ã—ãŸï¼ˆå†™çœŸã«ä¿å­˜ã§ãã¾ã™ï¼‰", "ğŸ“¤");
          return;
        }

        // B) æ–°è¦ã‚¿ãƒ–è¡¨ç¤º â†’ é•·æŠ¼ã—ä¿å­˜
        const url = URL.createObjectURL(blob);
        const w = window.open(url, "_blank");
        if (!w) window.location.href = url;
        showToast("ç”»åƒã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚é•·æŠ¼ã—â†’â€œå†™çœŸã«è¿½åŠ â€ã§ä¿å­˜ã—ã¦ãã ã•ã„", "ğŸ“Œ");
        setTimeout(() => URL.revokeObjectURL(url), 15000);

      } catch (e) {
        console.error(e);
        showToast("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¼ãƒ‰éƒ¨åˆ†ã‚’ã‚¹ã‚¯ã‚·ãƒ§ã§ã‚‚ç¶ºéº—ã«é€ã‚Œã¾ã™ğŸ™", "âš ï¸");
      } finally {
        if (wrapper && wrapper.parentNode) wrapper.parentNode.removeChild(wrapper);
      }
    }

    // ===== Init / Events =====
    function fillExample() {
      $("toName").value = "ä½è—¤ã•ã‚“";
      $("category").value = "help";
      $("message").value = "ãƒ”ãƒ¼ã‚¯ã®æ™‚é–“ã«ãƒ¬ã‚¸ã‚’åŠ©ã‘ã¦ãã‚Œã¦æœ¬å½“ã«åŠ©ã‹ã£ãŸï¼\nãŠã‹ã’ã§å…¨ä½“ãŒã‚¹ãƒ ãƒ¼ã‚ºã«å›ã£ãŸã‚ˆã€‚ã‚ã‚ŠãŒã¨ã†ï¼";
      $("fromName").value = "åº—é•· ç”°ä¸­";
      updatePreview();
      showToast("ä¾‹ã‚’å…¥ã‚Œã¾ã—ãŸã€‚å¥½ãã«ç·¨é›†ã—ã¦OKï¼", "âœ¨");
    }

    function resetAll() {
      $("toName").value = "";
      $("message").value = "";
      $("fromName").value = "";
      $("category").value = "always";
      updatePreview();
      showToast("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ", "â†º");
    }

    (function init() {
      const sel = $("category");
      CATEGORIES.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.key;
        opt.textContent = c.label;
        sel.appendChild(opt);
      });
      sel.value = "always";

      ["toName", "message", "fromName", "category"].forEach(id => {
        $(id).addEventListener("input", updatePreview);
        $(id).addEventListener("change", updatePreview);
      });

      $("btnDownload").addEventListener("click", downloadCard);
      $("btnFillExample").addEventListener("click", fillExample);
      $("btnReset").addEventListener("click", resetAll);

      // ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´æ™‚ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºãªã‚‰ãŠã™ã™ã‚æ–‡ã‚’å…¥ã‚Œã‚‹
      sel.addEventListener("change", () => {
        const msgEl = $("message");
        const msg = (msgEl.value || "").trim();
        if (!msg) {
          const c = CATEGORIES.find(x => x.key === sel.value);
          msgEl.value = c?.defaultMsg || "";
        }
        updatePreview();
      });

      $("cardDate").textContent = todayJP();
      updatePreview();

      window.addEventListener("resize", () => {
        clearTimeout(window.__rz);
        window.__rz = setTimeout(updatePreview, 80);
      });
    })();
  </script>
</body>
</html>
