<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚µãƒ³ã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvasï¼ˆPC/Androidå‘ã‘ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒˆï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®é›°å›²æ°—ï¼ˆiPhoneä¿å­˜ã¯Canvasã§æãã®ã§ã€ã“ã“ã¯è¦‹ãŸç›®å°‚ç”¨ï¼‰ */
    .paper {
      background-image:
        radial-gradient(1200px 600px at 20% 0%, rgba(255,255,255,.7), rgba(255,255,255,0)),
        radial-gradient(900px 500px at 90% 10%, rgba(255,255,255,.55), rgba(255,255,255,0)),
        radial-gradient(1200px 900px at 50% 100%, rgba(0,0,0,.06), rgba(0,0,0,0));
      background-blend-mode: overlay;
    }
    .grain { position: relative; overflow: hidden; }
    .grain::after{
      content:"";
      position:absolute; inset:-50%;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E");
      transform: rotate(6deg);
      pointer-events:none;
      mix-blend-mode:multiply;
      opacity:.22;
    }
    .shine { position: relative; }
    .shine::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(115deg, rgba(255,255,255,.25), rgba(255,255,255,0) 35%, rgba(255,255,255,.18) 55%, rgba(255,255,255,0) 75%);
      pointer-events:none;
      opacity:.8;
    }
    .card-shadow { box-shadow: 0 22px 50px rgba(0,0,0,.12), 0 10px 18px rgba(0,0,0,.08); }
    .wrap { white-space: pre-wrap; word-break: break-word; }
    .invalid { outline: 2px solid rgba(239,68,68,.8); outline-offset: 2px; }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['ui-sans-serif', 'system-ui', 'Hiragino Kaku Gothic ProN', 'Meiryo', 'sans-serif'],
          }
        }
      }
    }
  </script>
</head>

<body class="min-h-screen bg-gradient-to-b from-rose-50 via-amber-50 to-sky-50 text-slate-800">
<header class="sticky top-0 z-30 backdrop-blur bg-white/60 border-b border-white/40">
  <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3">
    <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-rose-400 to-amber-300 grid place-items-center shadow-sm">
      <span class="text-white text-lg">ğŸ’Œ</span>
    </div>
    <div class="min-w-0">
      <h1 class="text-base sm:text-lg font-bold tracking-tight truncate">ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚µãƒ³ã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
      <p class="text-xs sm:text-sm text-slate-600 truncate">LINEã‚„ãƒãƒ£ãƒƒãƒˆã§ã€Œã¡ã‚ƒã‚“ã¨ä¼ã‚ã‚‹ã€æ„Ÿè¬ã‚«ãƒ¼ãƒ‰ã‚’ä¸€ç¬ã§ã€‚</p>
    </div>
    <div class="ml-auto flex items-center gap-2">
      <button id="btnFillExample" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/70 hover:bg-white border border-white/70 shadow-sm text-sm">
        <span>âœ¨</span><span>ä¾‹ã‚’å…¥ã‚Œã‚‹</span>
      </button>
      <button id="btnReset" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/70 hover:bg-white border border-white/70 shadow-sm text-sm">
        <span>â†º</span><span>ãƒªã‚»ãƒƒãƒˆ</span>
      </button>
    </div>
  </div>
</header>

<main class="mx-auto max-w-6xl px-4 py-6 sm:py-10 grid gap-6 lg:grid-cols-2 lg:gap-10">
  <!-- Form -->
  <section class="order-2 lg:order-1">
    <div class="rounded-3xl bg-white/70 border border-white/70 shadow-sm p-4 sm:p-6">
      <h2 class="text-lg font-bold">å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h2>
      <p class="text-sm text-slate-600 mt-1">å…¥åŠ›ã—ãŸå†…å®¹ãŒå³ã®ã‚«ãƒ¼ãƒ‰ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ ã•ã‚Œã¾ã™ã€‚</p>

      <div class="mt-6 grid gap-4">
        <div>
          <label class="text-sm font-semibold">å®›å</label>
          <div class="mt-2 flex items-center gap-2">
            <input id="toName" type="text" maxlength="24"
              class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-200"
              placeholder="ä¾‹ï¼‰ä½è—¤ã•ã‚“" autocomplete="off" />
            <span class="text-xs text-slate-500 shrink-0">ã¸</span>
          </div>
          <p class="mt-1 text-xs text-slate-500">é•·ãã¦ã‚‚è‡ªå‹•ã§ç¸®å°ï¼†æŠ˜ã‚Šè¿”ã—ã¾ã™ï¼ˆæœ€å¤§24æ–‡å­—ï¼‰ã€‚</p>
        </div>

        <div>
          <label class="text-sm font-semibold">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚«ãƒ†ã‚´ãƒª</label>
          <div class="mt-2">
            <select id="category"
              class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-200"></select>
          </div>
          <p class="mt-1 text-xs text-slate-500">ã‚«ãƒ†ã‚´ãƒªã§èƒŒæ™¯è‰²ãƒ»ã‚¤ãƒ©ã‚¹ãƒˆãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</p>
        </div>

        <div>
          <label class="text-sm font-semibold">è‡ªç”±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆçŸ­ã‚ï¼‰</label>
          <div class="mt-2">
            <textarea id="message" rows="4" maxlength="220"
              class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-200"
              placeholder="ä¾‹ï¼‰å¿™ã—ã„æ™‚é–“å¸¯ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã‚Œã¦æœ¬å½“ã«åŠ©ã‹ã£ãŸï¼ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ï¼"></textarea>
          </div>
          <div class="mt-1 flex items-center justify-between text-xs text-slate-500">
            <span>æ”¹è¡ŒOKã€‚å…·ä½“çš„ã«æ›¸ãã¨åˆºã•ã‚Šã¾ã™ã€‚</span>
            <span><span id="msgCount">0</span>/220</span>
          </div>
        </div>

        <div>
          <label class="text-sm font-semibold">è´ˆã‚Šä¸»</label>
          <div class="mt-2 flex items-center gap-2">
            <input id="fromName" type="text" maxlength="24"
              class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-200"
              placeholder="ä¾‹ï¼‰åº—é•· ç”°ä¸­" autocomplete="off" />
            <span class="text-xs text-slate-500 shrink-0">ã‚ˆã‚Š</span>
          </div>
        </div>
      </div>

      <div class="mt-6 flex flex-col sm:flex-row gap-3 sm:items-center">
        <button id="btnDownload"
          class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl bg-gradient-to-r from-rose-500 to-amber-400 text-white font-semibold shadow-md hover:shadow-lg active:scale-[0.99] transition">
          <span>â¬‡ï¸</span>
          <span>ç”»åƒã¨ã—ã¦ä¿å­˜</span>
        </button>

        <div class="flex-1 rounded-2xl bg-white/70 border border-white/70 px-4 py-3 text-xs text-slate-600">
          <p class="font-semibold">iPhoneã¯å®‰å®šä¿å­˜ãƒ¢ãƒ¼ãƒ‰</p>
          <ul class="list-disc pl-5 mt-1 space-y-1">
            <li>iPhoneã¯Canvasæç”»ã§PNGç”Ÿæˆï¼ˆhtml2canvasä¸ä½¿ç”¨ï¼‰</li>
            <li>ã€Œå…±æœ‰ã€â†’ã€Œå†™çœŸã«ä¿å­˜ã€ãŒãŠã™ã™ã‚</li>
            <li>å…±æœ‰ãŒå‡ºãªã„å ´åˆã¯ç”»åƒã‚¿ãƒ–ã‚’é•·æŠ¼ã—ä¿å­˜</li>
          </ul>
        </div>
      </div>

      <div id="toast" class="pointer-events-none mt-4 hidden">
        <div class="rounded-2xl bg-slate-900 text-white px-4 py-3 text-sm shadow-lg inline-flex items-center gap-2">
          <span id="toastIcon">âœ…</span>
          <span id="toastMsg">ä¿å­˜ã—ã¾ã—ãŸ</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Preview -->
  <section class="order-1 lg:order-2">
    <div class="lg:sticky lg:top-24">
      <div class="flex items-end justify-between gap-3 mb-3">
        <div>
          <h2 class="text-lg font-bold">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
          <p class="text-sm text-slate-600">ãã®ã¾ã¾é€ã‚Œã‚‹â€œã¡ã‚‡ã†ã©ã„ã„ã‚µã‚¤ã‚ºæ„Ÿâ€ã€‚</p>
        </div>
        <div class="text-xs text-slate-500">æ¨å¥¨ï¼šã‚¹ãƒãƒ›ã§ä¿å­˜â†’LINEé€ä¿¡</div>
      </div>

      <div class="grid place-items-center">
        <div id="cardWrap" class="w-full max-w-[520px]">
          <div id="card"
            class="grain shine paper card-shadow rounded-[28px] border border-white/60 p-6 sm:p-8 relative select-none"
            style="background: linear-gradient(135deg, #ffe4e6, #fff7ed);">

            <div class="absolute -top-3 -right-3 h-16 w-16 rounded-3xl bg-white/50 blur-[1px]"></div>
            <div class="absolute -bottom-4 -left-4 h-20 w-20 rounded-3xl bg-white/40 blur-[1px]"></div>

            <div class="flex items-start justify-between gap-4">
              <div class="min-w-0">
                <div class="text-xs sm:text-sm text-slate-700/80">To:</div>
                <div id="cardTo" class="text-xl sm:text-2xl font-extrabold tracking-tight">ã€‡ã€‡ã•ã‚“ã¸</div>
              </div>
              <div class="shrink-0 text-right">
                <div class="text-3xl sm:text-4xl" id="cardIcon">ğŸ’–</div>
                <div id="cardBadge"
                  class="mt-2 inline-flex items-center px-3 py-1 rounded-full bg-white/70 border border-white/70 text-xs font-semibold">
                  ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†
                </div>
              </div>
            </div>

            <div class="mt-6 sm:mt-7">
              <div class="text-xs sm:text-sm text-slate-700/80">Message:</div>
              <div id="cardMessage"
                class="wrap mt-2 text-[15px] sm:text-base leading-relaxed font-medium text-slate-800">
                ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚çŸ­ãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚ã‚ãªãŸã®ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¯ã€ã¡ã‚ƒã‚“ã¨å±Šãã¾ã™ã€‚
              </div>
            </div>

            <div class="mt-6 sm:mt-7 h-px bg-white/70"></div>

            <div class="mt-5 flex items-end justify-between gap-3">
              <div class="text-xs sm:text-sm text-slate-700/80">
                <div class="font-semibold">From:</div>
                <div id="cardFrom" class="mt-1 text-sm sm:text-base font-bold">ã€‡ã€‡ã‚ˆã‚Š</div>
              </div>

              <div class="text-right">
                <div class="text-xs text-slate-700/70">#ThanksCard</div>
                <div class="mt-1 text-xs text-slate-700/70" id="cardDate"></div>
              </div>
            </div>

            <div id="exportNote" class="mt-4 text-[11px] text-slate-700/60">
              â€» ä¿å­˜ç”¨ç”»åƒã«ã¯ã“ã®æ³¨è¨˜ã¯å…¥ã‚Šã¾ã›ã‚“
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4 text-xs text-slate-600">
        <span class="font-semibold">é€ã‚‹å‰ã®ä¸€è¨€ä¾‹ï¼š</span>
        ã€Œä»Šæ—¥åŠ©ã‹ã£ãŸï¼ã¡ã‚‡ã£ã¨ã‚«ãƒ¼ãƒ‰ä½œã£ãŸã‹ã‚‰å—ã‘å–ã£ã¦ã€œã€
      </div>
    </div>
  </section>
</main>

<footer class="pb-10">
  <div class="mx-auto max-w-6xl px-4 text-xs text-slate-500">
    <p>Â© Thanks Card Generator / 1ãƒ•ã‚¡ã‚¤ãƒ«å®Œçµãƒ»å¤–éƒ¨ã‚µãƒ¼ãƒä¸è¦</p>
  </div>
</footer>

<script>
  // ===== Data =====
  const CATEGORIES = [
    { key: "help",     label: "ãƒ˜ãƒ«ãƒ—æ„Ÿè¬ï¼",       icon: "ğŸ«¶", gradient: ["#dbeafe","#fff7ed"], accent:"#3b82f6",
      defaultMsg:"å¿™ã—ã„æ™‚é–“å¸¯ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã‚Œã¦æœ¬å½“ã«åŠ©ã‹ã£ãŸï¼ã‚ã‚ŠãŒã¨ã†ï¼" },
    { key: "service",  label: "ç´ æ™´ã‚‰ã—ã„æ¥å®¢ï¼",   icon: "ğŸŒŸ", gradient: ["#fef9c3","#ffe4e6"], accent:"#f59e0b",
      defaultMsg:"ãŠå®¢æ§˜ã¸ã®å£°ã‹ã‘ãŒã™ã”ãä¸å¯§ã§ã€è¦‹ã¦ã„ã¦æ°—æŒã¡ã‚ˆã‹ã£ãŸï¼" },
    { key: "birthday", label: "èª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ï¼", icon: "ğŸ‚", gradient: ["#fae8ff","#e0f2fe"], accent:"#a855f7",
      defaultMsg:"ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ï¼ç´ æ•µãªä¸€å¹´ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ï¼" },
    { key: "always",   label: "ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†",   icon: "ğŸ’–", gradient: ["#ffe4e6","#fff7ed"], accent:"#ec4899",
      defaultMsg:"ã„ã¤ã‚‚æ”¯ãˆã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ã™ã”ãé ¼ã‚Šã«ã—ã¦ã„ã¾ã™ï¼" },
    { key: "team",     label: "ãƒãƒ¼ãƒ æœ€é«˜ï¼",       icon: "ğŸ¤", gradient: ["#dcfce7","#ecfeff"], accent:"#22c55e",
      defaultMsg:"ã¿ã‚“ãªã®é›°å›²æ°—ã‚’æ˜ã‚‹ãã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼" }
  ];

  const $ = (id) => document.getElementById(id);

  // ===== Helpers =====
  function todayJP() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}/${mm}/${dd}`;
  }

  function showToast(message, icon = "âœ…") {
    const toast = $("toast");
    $("toastMsg").textContent = message;
    $("toastIcon").textContent = icon;
    toast.classList.remove("hidden");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toast.classList.add("hidden"), 2600);
  }

  function sanitizeSingleLine(str) { return (str || "").replace(/\s+/g, " ").trim(); }

  function hexToRgba(hex, a) {
    const h = hex.replace("#", "").trim();
    const full = h.length === 3 ? h.split("").map(ch => ch + ch).join("") : h;
    const num = parseInt(full, 16);
    const r = (num >> 16) & 255;
    const g = (num >> 8) & 255;
    const b = num & 255;
    return `rgba(${r},${g},${b},${a})`;
  }

  function isIOS() {
    const ua = navigator.userAgent || "";
    return /iPad|iPhone|iPod/.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
  }

  function filenameSafe() {
    const safeTo = sanitizeSingleLine($("toName").value).replace(/[\\/:*?"<>|]/g, "");
    const stamp = todayJP().replaceAll("/", "");
    return `thanks-card_${safeTo || "card"}_${stamp}.png`;
  }

  // ===== Preview =====
  function setCardTheme(catKey) {
    const c = CATEGORIES.find(x => x.key === catKey) || CATEGORIES[0];
    $("card").style.background = `linear-gradient(135deg, ${c.gradient[0]}, ${c.gradient[1]})`;
    $("cardIcon").textContent = c.icon;
    $("cardBadge").textContent = c.label;
    $("cardBadge").style.boxShadow = `0 10px 20px ${hexToRgba(c.accent, 0.18)}`;
    $("cardBadge").style.borderColor = hexToRgba(c.accent, 0.18);
  }

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šTo/Fromã¯å¹…ã«å¿œã˜ã¦ç¸®å°ï¼ˆåˆ‡ã‚Œãªã„ï¼‰
  function fitTextPreview(el, maxPx, minPx) {
    if (!el) return;
    el.style.fontSize = maxPx + "px";
    el.style.lineHeight = "1.15";
    el.style.whiteSpace = "normal";
    el.style.wordBreak = "break-word";
    let size = maxPx, safety = 60;
    while (safety-- > 0 && (el.scrollWidth > el.clientWidth + 1) && size > minPx) {
      size -= 1;
      el.style.fontSize = size + "px";
    }
  }

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šæœ¬æ–‡ã¯ä¸€å®šè¡Œæ•°ã«åã‚ã‚‹ï¼ˆè¦‹ãŸç›®ç”¨ï¼‰ï¼‹ç¸®å°
  function clampMessagePreview() {
    const area = $("cardMessage");
    if (!area) return;
    const maxLines = window.matchMedia("(min-width: 640px)").matches ? 6 : 5;
    const basePx = window.matchMedia("(min-width: 640px)").matches ? 16 : 15;

    area.style.maxHeight = `calc(${maxLines} * 1.6em)`;
    area.style.overflow = "hidden";
    area.style.fontSize = basePx + "px";
    area.style.lineHeight = "1.6";

    let size = basePx, safety = 60;
    while (safety-- > 0 && area.scrollHeight > area.clientHeight + 2 && size > 13) {
      size -= 1;
      area.style.fontSize = size + "px";
    }
  }

  function updatePreview() {
    const to = sanitizeSingleLine($("toName").value);
    const from = sanitizeSingleLine($("fromName").value);
    const msg = ($("message").value || "").trim();
    const cat = $("category").value;

    setCardTheme(cat);

    $("msgCount").textContent = String(msg.length);
    $("cardTo").textContent = (to ? `${to}ã¸` : "ã€‡ã€‡ã•ã‚“ã¸");
    $("cardFrom").textContent = (from ? `${from}ã‚ˆã‚Š` : "ã€‡ã€‡ã‚ˆã‚Š");
    $("cardMessage").textContent = msg || "ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚çŸ­ãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚ã‚ãªãŸã®ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¯ã€ã¡ã‚ƒã‚“ã¨å±Šãã¾ã™ã€‚";
    $("cardDate").textContent = todayJP();

    // è‡ªå‹•ç¸®å°ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
    const toEl = $("cardTo");
    const fromEl = $("cardFrom");
    const toMax = window.matchMedia("(min-width: 640px)").matches ? 28 : 22;
    fitTextPreview(toEl, toMax, 14);
    const fromMax = window.matchMedia("(min-width: 640px)").matches ? 16 : 15;
    fitTextPreview(fromEl, fromMax, 12);

    clampMessagePreview();
  }

  function validateForSave() {
    const toEl = $("toName");
    const fromEl = $("fromName");
    const msgEl = $("message");
    [toEl, fromEl, msgEl].forEach(el => el.classList.remove("invalid"));

    const to = sanitizeSingleLine(toEl.value);
    const from = sanitizeSingleLine(fromEl.value);
    const msg = (msgEl.value || "").trim();

    let ok = true;
    if (!to) { toEl.classList.add("invalid"); ok = false; }
    if (!from) { fromEl.classList.add("invalid"); ok = false; }
    if (!msg) { msgEl.classList.add("invalid"); ok = false; }

    if (!ok) showToast("å®›åãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»è´ˆã‚Šä¸»ã‚’å…¥ã‚Œã‚‹ã¨ã€ã‚‚ã£ã¨å¬‰ã—ã„ã‚«ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ï¼", "âš ï¸");
    return ok;
  }

  // ===== Save (Unified) =====
  async function saveBlobAsImage(blob) {
    const file = new File([blob], filenameSafe(), { type: "image/png" });

    // Shareï¼ˆæœ€å„ªå…ˆï¼‰
    if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
      await navigator.share({ files: [file], title: "Thanks Card" });
      showToast("å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãã¾ã—ãŸï¼ˆå†™çœŸã«ä¿å­˜ã§ãã¾ã™ï¼‰", "ğŸ“¤");
      return;
    }

    // æ–°è¦ã‚¿ãƒ–è¡¨ç¤º â†’ é•·æŠ¼ã—ä¿å­˜
    const url = URL.createObjectURL(blob);
    const w = window.open(url, "_blank");
    if (!w) window.location.href = url;
    showToast("ç”»åƒã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚é•·æŠ¼ã—â†’â€œå†™çœŸã«è¿½åŠ â€ã§ä¿å­˜ã—ã¦ãã ã•ã„", "ğŸ“Œ");
    setTimeout(() => URL.revokeObjectURL(url), 15000);
  }

  // ===== PC/Android: html2canvas route =====
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  function buildExportCloneForHtml2Canvas() {
    // html2canvasã¯iOSã§ä¸å®‰å®šãªã®ã§ã€ã“ã“ã¯PC/Androidå‘ã‘
    const original = $("card");
    const clone = original.cloneNode(true);

    const note = clone.querySelector("#exportNote");
    if (note) note.remove();

    // ä¿å­˜æ™‚ã¯åˆ‡ã‚‰ãªã„
    const msg = clone.querySelector("#cardMessage");
    if (msg) {
      msg.style.maxHeight = "none";
      msg.style.overflow = "visible";
    }

    const wrapper = document.createElement("div");
    wrapper.style.position = "fixed";
    wrapper.style.left = "-99999px";
    wrapper.style.top = "0";
    wrapper.style.width = "1080px";
    wrapper.style.zIndex = "-1";
    clone.style.width = "1080px";
    clone.style.maxWidth = "1080px";

    wrapper.appendChild(clone);
    document.body.appendChild(wrapper);
    return { wrapper, clone };
  }

  function autoFitCloneText(clone) {
    // 1080pxå›ºå®šå¹…ã§ã€Œåˆ‡ã‚Œãªã„ã€ã‚ˆã†ã«ç¸®å°ãƒ»æŠ˜è¿”ã—
    const toEl = clone.querySelector("#cardTo");
    const fromEl = clone.querySelector("#cardFrom");
    const msgEl = clone.querySelector("#cardMessage");

    const fitWidth = (el, maxPx, minPx) => {
      if (!el) return;
      el.style.whiteSpace = "normal";
      el.style.wordBreak = "break-word";
      el.style.fontSize = maxPx + "px";
      el.style.lineHeight = "1.15";
      let s = maxPx, safety = 120;
      while (safety-- > 0 && el.scrollWidth > el.clientWidth + 1 && s > minPx) {
        s -= 1;
        el.style.fontSize = s + "px";
      }
      // 2è¡Œã‚’è¶…ãˆãã†ãªã‚‰ã•ã‚‰ã«ç¸®å°ï¼ˆå®›åãŒé•·ã„æ™‚ï¼‰
      const lh = parseFloat(getComputedStyle(el).lineHeight) || (maxPx * 1.15);
      const maxH = lh * 2.15;
      safety = 80;
      while (safety-- > 0 && el.scrollHeight > maxH && s > minPx) {
        s -= 1;
        el.style.fontSize = s + "px";
      }
    };

    fitWidth(toEl, 54, 26);
    fitWidth(fromEl, 34, 20);

    if (msgEl) {
      msgEl.style.whiteSpace = "pre-wrap";
      msgEl.style.wordBreak = "break-word";
      msgEl.style.lineHeight = "1.6";
      msgEl.style.fontSize = "32px";
      const cardH = clone.getBoundingClientRect().height || 1200;
      const allowed = cardH * 0.42;
      let s = 32, safety = 120;
      while (safety-- > 0 && msgEl.scrollHeight > allowed && s > 22) {
        s -= 1;
        msgEl.style.fontSize = s + "px";
      }
    }
  }

  async function exportByHtml2Canvas() {
    let wrapper, clone;
    try {
      ({ wrapper, clone } = buildExportCloneForHtml2Canvas());
      await sleep(30);
      await new Promise(requestAnimationFrame);
      await new Promise(requestAnimationFrame);
      autoFitCloneText(clone);
      await new Promise(requestAnimationFrame);

      const scale = Math.min(2.5, Math.max(2, (window.devicePixelRatio || 2)));
      const canvas = await html2canvas(clone, {
        backgroundColor: null,
        scale,
        useCORS: true,
        logging: false,
        windowWidth: 1080,
        width: 1080,
        scrollX: 0,
        scrollY: 0
      });

      const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
      if (!blob) throw new Error("toBlob failed");
      return blob;
    } finally {
      if (wrapper && wrapper.parentNode) wrapper.parentNode.removeChild(wrapper);
    }
  }

  // ===== iPhone: Canvas draw route (å®‰å®š) =====
  function roundRectPath(ctx, x, y, w, h, r) {
    const rr = Math.min(r, w / 2, h / 2);
    ctx.beginPath();
    ctx.moveTo(x + rr, y);
    ctx.arcTo(x + w, y, x + w, y + h, rr);
    ctx.arcTo(x + w, y + h, x, y + h, rr);
    ctx.arcTo(x, y + h, x, y, rr);
    ctx.arcTo(x, y, x + w, y, rr);
    ctx.closePath();
  }

  function wrapText(ctx, text, maxWidth) {
    // æ”¹è¡Œä¿æŒ + å˜èª/æ–‡å­—ã§æŠ˜è¿”ã—
    const lines = [];
    const raw = (text || "").split("\n");
    for (const chunk of raw) {
      let line = "";
      for (const ch of chunk) {
        const test = line + ch;
        if (ctx.measureText(test).width > maxWidth && line) {
          lines.push(line);
          line = ch;
        } else {
          line = test;
        }
      }
      lines.push(line);
    }
    return lines;
  }

  function fitFontToWidth(ctx, text, maxPx, minPx, maxWidth) {
    let s = maxPx;
    for (; s >= minPx; s--) {
      ctx.font = `800 ${s}px system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif`;
      if (ctx.measureText(text).width <= maxWidth) break;
    }
    return s;
  }

  function fitFontToBox(ctx, text, maxPx, minPx, maxWidth, maxHeight, lineHeight) {
    let s = maxPx;
    for (; s >= minPx; s--) {
      ctx.font = `600 ${s}px system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif`;
      const lines = wrapText(ctx, text, maxWidth);
      const h = lines.length * (s * lineHeight);
      if (h <= maxHeight) break;
    }
    return s;
  }

  async function exportByCanvasDraw() {
    const cat = CATEGORIES.find(x => x.key === $("category").value) || CATEGORIES[0];
    const to = (sanitizeSingleLine($("toName").value) ? `${sanitizeSingleLine($("toName").value)}ã¸` : "ã€‡ã€‡ã•ã‚“ã¸");
    const from = (sanitizeSingleLine($("fromName").value) ? `${sanitizeSingleLine($("fromName").value)}ã‚ˆã‚Š` : "ã€‡ã€‡ã‚ˆã‚Š");
    const msg = ($("message").value || "").trim() || "ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚çŸ­ãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚ã‚ãªãŸã®ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¯ã€ã¡ã‚ƒã‚“ã¨å±Šãã¾ã™ã€‚";
    const date = todayJP();

    // å‡ºåŠ›ã‚µã‚¤ã‚ºï¼ˆLINEã§ç¶ºéº— + iPhoneã§å®‰å®šï¼‰
    const W = 1080;
    const H = 720; // ååˆºã€œãƒã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã£ã½ã„æ¨ªé•·
    const dpr = Math.min(2, (window.devicePixelRatio || 2)); // iPhoneã¯ä¸Šã’ã™ããªã„
    const canvas = document.createElement("canvas");
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    const ctx = canvas.getContext("2d");
    ctx.scale(dpr, dpr);

    // èƒŒæ™¯ï¼ˆè§’ä¸¸ã‚«ãƒ¼ãƒ‰ï¼‰
    const pad = 36;
    const x = 0, y = 0, w = W, h = H;
    const radius = 56;

    // å½±
    ctx.save();
    ctx.shadowColor = "rgba(0,0,0,0.14)";
    ctx.shadowBlur = 30;
    ctx.shadowOffsetY = 18;
    roundRectPath(ctx, x + 22, y + 16, w - 44, h - 32, radius);
    ctx.fillStyle = "rgba(255,255,255,0.01)";
    ctx.fill();
    ctx.restore();

    // æœ¬ä½“
    roundRectPath(ctx, x + 20, y + 10, w - 40, h - 20, radius);
    ctx.save();
    ctx.clip();

    // ã‚°ãƒ©ãƒ‡
    const grd = ctx.createLinearGradient(0, 0, W, H);
    grd.addColorStop(0, cat.gradient[0]);
    grd.addColorStop(1, cat.gradient[1]);
    ctx.fillStyle = grd;
    ctx.fillRect(0, 0, W, H);

    // æŸ”ã‚‰ã‹ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    const hl = ctx.createRadialGradient(W * 0.2, H * 0.05, 0, W * 0.2, H * 0.05, W * 0.9);
    hl.addColorStop(0, "rgba(255,255,255,0.60)");
    hl.addColorStop(1, "rgba(255,255,255,0)");
    ctx.fillStyle = hl;
    ctx.fillRect(0, 0, W, H);

    // ã†ã£ã™ã‚‰ç²’å­ï¼ˆè»½é‡ç‰ˆï¼‰
    ctx.globalAlpha = 0.08;
    ctx.fillStyle = "rgba(0,0,0,1)";
    for (let i = 0; i < 900; i++) {
      const px = Math.random() * W;
      const py = Math.random() * H;
      ctx.fillRect(px, py, 1, 1);
    }
    ctx.globalAlpha = 1;

    ctx.restore(); // clipè§£é™¤

    // ãƒ†ã‚­ã‚¹ãƒˆé ˜åŸŸ
    const cardX = x + 20, cardY = y + 10, cardW = w - 40, cardH = h - 20;
    const leftX = cardX + pad;
    const rightX = cardX + cardW - pad;

    // å³ä¸Šã‚¢ã‚¤ã‚³ãƒ³
    ctx.font = `700 72px system-ui, -apple-system, "Apple Color Emoji", "Segoe UI Emoji"`;
    ctx.textAlign = "right";
    ctx.textBaseline = "top";
    ctx.fillStyle = "rgba(15,23,42,0.92)";
    ctx.fillText(cat.icon, rightX, cardY + 34);

    // ãƒãƒƒã‚¸
    const badgeText = cat.label;
    ctx.font = `700 26px system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif`;
    const badgePadX = 18, badgePadY = 10;
    const badgeW = ctx.measureText(badgeText).width + badgePadX * 2;
    const badgeH = 26 + badgePadY * 2;
    const badgeX = rightX - badgeW;
    const badgeY = cardY + 120;

    ctx.save();
    roundRectPath(ctx, badgeX, badgeY, badgeW, badgeH, 999);
    ctx.fillStyle = "rgba(255,255,255,0.72)";
    ctx.fill();
    ctx.strokeStyle = hexToRgba(cat.accent, 0.20);
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.restore();

    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "rgba(15,23,42,0.92)";
    ctx.fillText(badgeText, badgeX + badgePadX, badgeY + badgeH / 2);

    // To ãƒ©ãƒ™ãƒ«
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    ctx.fillStyle = "rgba(51,65,85,0.75)";
    ctx.font = `600 22px system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif`;
    ctx.fillText("To:", leftX, cardY + 40);

    // To æœ¬æ–‡ï¼ˆè‡ªå‹•ç¸®å°ï¼‹æœ€å¤§2è¡Œï¼‰
    const toAreaW = (badgeX - 16) - leftX; // å³å´é ˜åŸŸã‚’é¿ã‘ã‚‹
    const toMax = 54, toMin = 28;
    let toSize = fitFontToWidth(ctx, to, toMax, toMin, toAreaW);
    ctx.font = `800 ${toSize}px system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif`;
    ctx.fillStyle = "rgba(15,23,42,0.94)";
    const toLines = wrapText(ctx, to, toAreaW);
    const toShow = toLines.slice(0, 2);
    const toTop = cardY + 68;
    const toLH = toSize * 1.12;
    toShow.forEach((ln, i) => ctx.fillText(ln, leftX, toTop + i * toLH));

    // Message ãƒ©ãƒ™ãƒ«
    const msgLabelY = cardY + 190;
    ctx.fillStyle = "rgba(51,65,85,0.75)";
    ctx.font = `600 22px system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif`;
    ctx.fillText("Message:", leftX, msgLabelY);

    // Message æœ¬æ–‡ï¼ˆãƒœãƒƒã‚¯ã‚¹ã«åã¾ã‚‹ã¾ã§è‡ªå‹•ç¸®å°ï¼‰
    const msgX = leftX;
    const msgY = msgLabelY + 36;
    const msgW = cardX + cardW - pad - msgX;
    const msgH = 260;
    const msgMax = 34, msgMin = 22;
    const lineHeight = 1.55;
    const msgSize = fitFontToBox(ctx, msg, msgMax, msgMin, msgW, msgH, lineHeight);
    ctx.font = `600 ${msgSize}px system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif`;
    ctx.fillStyle = "rgba(15,23,42,0.90)";
    ctx.textBaseline = "top";
    const msgLines = wrapText(ctx, msg, msgW);
    const lh = msgSize * lineHeight;
    let yy = msgY;
    for (const ln of msgLines) {
      if (yy + lh > msgY + msgH) break;
      ctx.fillText(ln, msgX, yy);
      yy += lh;
    }

    // Divider
    const divY = cardY + 520;
    ctx.strokeStyle = "rgba(255,255,255,0.75)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(cardX + pad, divY);
    ctx.lineTo(cardX + cardW - pad, divY);
    ctx.stroke();

    // From
    ctx.textBaseline = "top";
    ctx.fillStyle = "rgba(51,65,85,0.75)";
    ctx.font = `700 22px system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif`;
    ctx.fillText("From:", leftX, divY + 28);

    // From æœ¬æ–‡ï¼ˆè‡ªå‹•ç¸®å°ï¼‰
    const fromAreaW = (cardX + cardW - pad) - leftX;
    const fromMax = 34, fromMin = 20;
    fitFontToWidth(ctx, from, fromMax, fromMin, fromAreaW);
    // fitFontToWidth ã¯ font ã‚’ä¸Šæ›¸ãã™ã‚‹ã®ã§å†é©ç”¨
    let s = fromMax;
    for (; s >= fromMin; s--) {
      ctx.font = `800 ${s}px system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif`;
      if (ctx.measureText(from).width <= fromAreaW) break;
    }
    ctx.fillStyle = "rgba(15,23,42,0.92)";
    ctx.fillText(from, leftX, divY + 60);

    // Right bottom: hashtag + date
    ctx.textAlign = "right";
    ctx.fillStyle = "rgba(51,65,85,0.70)";
    ctx.font = `600 20px system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif`;
    ctx.fillText("#ThanksCard", cardX + cardW - pad, divY + 34);
    ctx.fillText(date, cardX + cardW - pad, divY + 62);

    // export blob
    const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
    if (!blob) throw new Error("Canvas toBlob failed");
    return blob;
  }

  // ===== Download handler =====
  async function downloadCard() {
    if (!validateForSave()) return;

    try {
      // iPhoneã¯æœ€åˆã‹ã‚‰Canvasæç”»ï¼ˆhtml2canvasã§å¤±æ•—ã—ãŒã¡ãªã®ã§å›é¿ï¼‰
      const blob = isIOS()
        ? await exportByCanvasDraw()
        : await exportByHtml2Canvas();

      await saveBlobAsImage(blob);
    } catch (e) {
      console.error(e);
      // ã“ã“ã¾ã§æ¥ãŸã‚‰æœ¬å½“ã«ä¾‹å¤–ãªã®ã§ã€æœ€å¾Œã®é€ƒã’é“ã‚’æç¤º
      showToast("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¼ãƒ‰éƒ¨åˆ†ã‚’ã‚¹ã‚¯ã‚·ãƒ§ã§ã‚‚ç¶ºéº—ã«é€ã‚Œã¾ã™ğŸ™", "âš ï¸");
    }
  }

  // ===== Example/Reset =====
  function fillExample() {
    $("toName").value = "ä½è—¤ã•ã‚“";
    $("category").value = "help";
    $("message").value = "ãƒ”ãƒ¼ã‚¯ã®æ™‚é–“ã«ãƒ¬ã‚¸ã‚’åŠ©ã‘ã¦ãã‚Œã¦æœ¬å½“ã«åŠ©ã‹ã£ãŸï¼\nãŠã‹ã’ã§å…¨ä½“ãŒã‚¹ãƒ ãƒ¼ã‚ºã«å›ã£ãŸã‚ˆã€‚ã‚ã‚ŠãŒã¨ã†ï¼";
    $("fromName").value = "åº—é•· ç”°ä¸­";
    updatePreview();
    showToast("ä¾‹ã‚’å…¥ã‚Œã¾ã—ãŸã€‚å¥½ãã«ç·¨é›†ã—ã¦OKï¼", "âœ¨");
  }

  function resetAll() {
    $("toName").value = "";
    $("message").value = "";
    $("fromName").value = "";
    $("category").value = "always";
    updatePreview();
    showToast("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ", "â†º");
  }

  // ===== Init =====
  (function init() {
    const sel = $("category");
    CATEGORIES.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.key;
      opt.textContent = c.label;
      sel.appendChild(opt);
    });
    sel.value = "always";

    ["toName", "message", "fromName", "category"].forEach(id => {
      $(id).addEventListener("input", updatePreview);
      $(id).addEventListener("change", updatePreview);
    });

    $("btnDownload").addEventListener("click", downloadCard);
    $("btnFillExample").addEventListener("click", fillExample);
    $("btnReset").addEventListener("click", resetAll);

    sel.addEventListener("change", () => {
      const msgEl = $("message");
      const msg = (msgEl.value || "").trim();
      if (!msg) {
        const c = CATEGORIES.find(x => x.key === sel.value);
        msgEl.value = c?.defaultMsg || "";
      }
      updatePreview();
    });

    $("cardDate").textContent = todayJP();
    updatePreview();

    window.addEventListener("resize", () => {
      clearTimeout(window.__rz);
      window.__rz = setTimeout(updatePreview, 80);
    });

    if (isIOS()) {
      setTimeout(() => showToast("iPhoneã¯å®‰å®šä¿å­˜ãƒ¢ãƒ¼ãƒ‰ã§æ›¸ãå‡ºã—ã¾ã™ï¼ˆå…±æœ‰â†’å†™çœŸã«ä¿å­˜ãŒâ—ï¼‰", "ğŸ“±"), 1200);
    }
  })();
</script>
</body>
</html>
