<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚µãƒ³ã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* ãµã‚ã£ã¨ã—ãŸç´™è³ª&ã‚¤ãƒ³ã‚¯æ„Ÿã®æ¼”å‡ºï¼ˆã‚¹ã‚¯ã‚·ãƒ§ã§ã‚‚ç¶ºéº—ï¼‰ */
    .paper {
      background-image:
        radial-gradient(1200px 600px at 20% 0%, rgba(255,255,255,.7), rgba(255,255,255,0)),
        radial-gradient(900px 500px at 90% 10%, rgba(255,255,255,.55), rgba(255,255,255,0)),
        radial-gradient(1200px 900px at 50% 100%, rgba(0,0,0,.06), rgba(0,0,0,0));
      background-blend-mode: overlay;
    }
    .grain {
      position: relative;
      overflow: hidden;
    }
    .grain::after{
      content:"";
      position:absolute; inset:-50%;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.14'/%3E%3C/svg%3E");
      transform: rotate(6deg);
      pointer-events:none;
      mix-blend-mode:multiply;
      opacity:.22;
    }
    .shine {
      position: relative;
    }
    .shine::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(115deg, rgba(255,255,255,.25), rgba(255,255,255,0) 35%, rgba(255,255,255,.18) 55%, rgba(255,255,255,0) 75%);
      pointer-events:none;
      opacity:.8;
    }

    /* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã®ç”»è³ªå®‰å®šã®ãŸã‚ã€ã‚«ãƒ¼ãƒ‰å†…éƒ¨ã¯ transform ã‚’æ§ãˆã‚ã« */
    .card-shadow { box-shadow: 0 22px 50px rgba(0,0,0,.12), 0 10px 18px rgba(0,0,0,.08); }

    /* ãƒ†ã‚­ã‚¹ãƒˆã®æ”¹è¡Œã¨é•·æ–‡ã¯è‡ªç„¶ã«æŠ˜ã‚Šè¿”ã™ */
    .wrap { white-space: pre-wrap; word-break: break-word; }

    /* å…¥åŠ›ã®ã‚¨ãƒ©ãƒ¼ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .invalid { outline: 2px solid rgba(239,68,68,.8); outline-offset: 2px; }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['ui-sans-serif', 'system-ui', 'Hiragino Kaku Gothic ProN', 'Meiryo', 'sans-serif'],
          }
        }
      }
    }
  </script>
</head>

<body class="min-h-screen bg-gradient-to-b from-rose-50 via-amber-50 to-sky-50 text-slate-800">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/60 border-b border-white/40">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3">
      <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-rose-400 to-amber-300 grid place-items-center shadow-sm">
        <span class="text-white text-lg">ğŸ’Œ</span>
      </div>
      <div class="min-w-0">
        <h1 class="text-base sm:text-lg font-bold tracking-tight truncate">ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚µãƒ³ã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰ ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
        <p class="text-xs sm:text-sm text-slate-600 truncate">LINEã‚„ãƒãƒ£ãƒƒãƒˆã§ã€Œã¡ã‚ƒã‚“ã¨ä¼ã‚ã‚‹ã€æ„Ÿè¬ã‚«ãƒ¼ãƒ‰ã‚’ä¸€ç¬ã§ã€‚</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnFillExample" class="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/70 hover:bg-white border border-white/70 shadow-sm text-sm">
          <span>âœ¨</span><span>ä¾‹ã‚’å…¥ã‚Œã‚‹</span>
        </button>
        <button id="btnReset" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/70 hover:bg-white border border-white/70 shadow-sm text-sm">
          <span>â†º</span><span>ãƒªã‚»ãƒƒãƒˆ</span>
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6 sm:py-10 grid gap-6 lg:grid-cols-2 lg:gap-10">
    <!-- Left: Form -->
    <section class="order-2 lg:order-1">
      <div class="rounded-3xl bg-white/70 border border-white/70 shadow-sm p-4 sm:p-6">
        <h2 class="text-lg font-bold">å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h2>
        <p class="text-sm text-slate-600 mt-1">å…¥åŠ›ã—ãŸå†…å®¹ãŒå³ã®ã‚«ãƒ¼ãƒ‰ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ ã•ã‚Œã¾ã™ã€‚</p>

        <div class="mt-6 grid gap-4">
          <div>
            <label class="text-sm font-semibold">å®›å</label>
            <div class="mt-2 flex items-center gap-2">
              <input id="toName" type="text" maxlength="14"
                class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-200"
                placeholder="ä¾‹ï¼‰ä½è—¤ã•ã‚“" autocomplete="off" />
              <span class="text-xs text-slate-500 shrink-0">ã¸</span>
            </div>
            <p class="mt-1 text-xs text-slate-500">çŸ­ã‚ãŒè¦‹ã‚„ã™ã„ã§ã™ï¼ˆæœ€å¤§14æ–‡å­—ï¼‰ã€‚</p>
          </div>

          <div>
            <label class="text-sm font-semibold">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚«ãƒ†ã‚´ãƒª</label>
            <div class="mt-2">
              <select id="category"
                class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-200">
              </select>
            </div>
            <p class="mt-1 text-xs text-slate-500">ã‚«ãƒ†ã‚´ãƒªã§èƒŒæ™¯è‰²ãƒ»ã‚¤ãƒ©ã‚¹ãƒˆãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚</p>
          </div>

          <div>
            <label class="text-sm font-semibold">è‡ªç”±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆçŸ­ã‚ï¼‰</label>
            <div class="mt-2">
              <textarea id="message" rows="4" maxlength="120"
                class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-200"
                placeholder="ä¾‹ï¼‰å¿™ã—ã„æ™‚é–“å¸¯ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã‚Œã¦æœ¬å½“ã«åŠ©ã‹ã£ãŸï¼ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ï¼"></textarea>
            </div>
            <div class="mt-1 flex items-center justify-between text-xs text-slate-500">
              <span id="msgHint">æ”¹è¡Œã‚‚OKã€‚ç›¸æ‰‹ã®è¡Œå‹•ã‚’å…·ä½“çš„ã«æ›¸ãã¨åˆºã•ã‚Šã¾ã™ã€‚</span>
              <span><span id="msgCount">0</span>/120</span>
            </div>
          </div>

          <div>
            <label class="text-sm font-semibold">è´ˆã‚Šä¸»</label>
            <div class="mt-2 flex items-center gap-2">
              <input id="fromName" type="text" maxlength="14"
                class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-rose-200"
                placeholder="ä¾‹ï¼‰åº—é•· ç”°ä¸­" autocomplete="off" />
              <span class="text-xs text-slate-500 shrink-0">ã‚ˆã‚Š</span>
            </div>
          </div>
        </div>

        <div class="mt-6 flex flex-col sm:flex-row gap-3 sm:items-center">
          <button id="btnDownload"
            class="inline-flex items-center justify-center gap-2 px-4 py-3 rounded-2xl bg-gradient-to-r from-rose-500 to-amber-400 text-white font-semibold shadow-md hover:shadow-lg active:scale-[0.99] transition">
            <span>â¬‡ï¸</span>
            <span>ç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
          </button>

          <div class="flex-1 rounded-2xl bg-white/70 border border-white/70 px-4 py-3 text-xs text-slate-600">
            <p class="font-semibold">ã‚³ãƒ„</p>
            <ul class="list-disc pl-5 mt-1 space-y-1">
              <li>å®›åã¨è´ˆã‚Šä¸»ãŒå…¥ã‚‹ã¨ã€Œä¿å­˜ã—ãŸããªã‚‹æ„Ÿã€UP</li>
              <li>é•·æ–‡ã¯è‡ªå‹•ã§åã¾ã‚‹ã‚ˆã†èª¿æ•´ã•ã‚Œã¾ã™</li>
              <li>ã†ã¾ãä¿å­˜ã§ããªã„å ´åˆã¯ã€ã‚«ãƒ¼ãƒ‰ã‚’ã‚¹ã‚¯ã‚·ãƒ§ã§ã‚‚ç¶ºéº—ã§ã™</li>
            </ul>
          </div>
        </div>

        <div id="toast" class="pointer-events-none mt-4 hidden">
          <div class="rounded-2xl bg-slate-900 text-white px-4 py-3 text-sm shadow-lg inline-flex items-center gap-2">
            <span id="toastIcon">âœ…</span>
            <span id="toastMsg">ä¿å­˜ã—ã¾ã—ãŸ</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Right: Live Card Preview -->
    <section class="order-1 lg:order-2">
      <div class="lg:sticky lg:top-24">
        <div class="flex items-end justify-between gap-3 mb-3">
          <div>
            <h2 class="text-lg font-bold">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
            <p class="text-sm text-slate-600">ãã®ã¾ã¾é€ã‚Œã‚‹â€œã¡ã‚‡ã†ã©ã„ã„ã‚µã‚¤ã‚ºæ„Ÿâ€ã€‚</p>
          </div>
          <div class="text-xs text-slate-500">æ¨å¥¨ï¼šã‚¹ãƒãƒ›ã§ä¿å­˜â†’LINEé€ä¿¡</div>
        </div>

        <!-- Card container centered -->
        <div class="grid place-items-center">
          <!-- The element to capture -->
          <div id="cardWrap" class="w-full max-w-[520px]">
            <div id="card"
              class="grain shine paper card-shadow rounded-[28px] border border-white/60 p-6 sm:p-8 relative select-none"
              style="background: linear-gradient(135deg, #ffe4e6, #fff7ed);">
              <!-- Decorative corner doodles -->
              <div class="absolute -top-3 -right-3 h-16 w-16 rounded-3xl bg-white/50 blur-[1px]"></div>
              <div class="absolute -bottom-4 -left-4 h-20 w-20 rounded-3xl bg-white/40 blur-[1px]"></div>

              <!-- Header -->
              <div class="flex items-start justify-between gap-4">
                <div class="min-w-0">
                  <div class="text-xs sm:text-sm text-slate-700/80">To:</div>
                  <div id="cardTo" class="text-xl sm:text-2xl font-extrabold tracking-tight truncate">ã€‡ã€‡ã•ã‚“ã¸</div>
                </div>
                <div class="shrink-0 text-right">
                  <div class="text-3xl sm:text-4xl" id="cardIcon">ğŸ’–</div>
                  <div id="cardBadge"
                       class="mt-2 inline-flex items-center px-3 py-1 rounded-full bg-white/70 border border-white/70 text-xs font-semibold">
                    ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†
                  </div>
                </div>
              </div>

              <!-- Message -->
              <div class="mt-6 sm:mt-7">
                <div class="text-xs sm:text-sm text-slate-700/80">Message:</div>
                <div id="cardMessage"
                     class="wrap mt-2 text-[15px] sm:text-base leading-relaxed font-medium text-slate-800">
                  ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚çŸ­ãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚ã‚ãªãŸã®ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¯ã€ã¡ã‚ƒã‚“ã¨å±Šãã¾ã™ã€‚
                </div>
              </div>

              <!-- Divider -->
              <div class="mt-6 sm:mt-7 h-px bg-white/70"></div>

              <!-- Footer -->
              <div class="mt-5 flex items-end justify-between gap-3">
                <div class="text-xs sm:text-sm text-slate-700/80">
                  <div class="font-semibold">From:</div>
                  <div id="cardFrom" class="mt-1 text-sm sm:text-base font-bold">ã€‡ã€‡ã‚ˆã‚Š</div>
                </div>

                <div class="text-right">
                  <div id="cardMini" class="text-xs text-slate-700/70">#ThanksCard</div>
                  <div class="mt-1 text-xs text-slate-700/70" id="cardDate"></div>
                </div>
              </div>

              <!-- Safe area note (only for preview; hidden during export) -->
              <div id="exportNote"
                   class="mt-4 text-[11px] text-slate-700/60">
                â€» ä¿å­˜ç”¨ç”»åƒã«ã¯ã“ã®æ³¨è¨˜ã¯å…¥ã‚Šã¾ã›ã‚“
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4 text-xs text-slate-600">
          <span class="font-semibold">é€ã‚‹å‰ã®ä¸€è¨€ä¾‹ï¼š</span>
          ã€Œä»Šæ—¥åŠ©ã‹ã£ãŸï¼ã¡ã‚‡ã£ã¨ã‚«ãƒ¼ãƒ‰ä½œã£ãŸã‹ã‚‰å—ã‘å–ã£ã¦ã€œã€
        </div>
      </div>
    </section>
  </main>

  <footer class="pb-10">
    <div class="mx-auto max-w-6xl px-4 text-xs text-slate-500">
      <p>Â© Thanks Card Generator / 1ãƒ•ã‚¡ã‚¤ãƒ«å®Œçµãƒ»å¤–éƒ¨ã‚µãƒ¼ãƒä¸è¦</p>
    </div>
  </footer>

  <script>
    // ====== Data ======
    const CATEGORIES = [
      {
        key: "help",
        label: "ãƒ˜ãƒ«ãƒ—æ„Ÿè¬ï¼",
        icon: "ğŸ«¶",
        gradient: ["#dbeafe", "#fff7ed"], // blue -> warm
        accent: "#3b82f6",
        defaultMsg: "å¿™ã—ã„æ™‚é–“å¸¯ã«ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã‚Œã¦æœ¬å½“ã«åŠ©ã‹ã£ãŸï¼ã‚ã‚ŠãŒã¨ã†ï¼"
      },
      {
        key: "service",
        label: "ç´ æ™´ã‚‰ã—ã„æ¥å®¢ï¼",
        icon: "ğŸŒŸ",
        gradient: ["#fef9c3", "#ffe4e6"], // yellow -> rose
        accent: "#f59e0b",
        defaultMsg: "ãŠå®¢æ§˜ã¸ã®å£°ã‹ã‘ãŒã™ã”ãä¸å¯§ã§ã€è¦‹ã¦ã„ã¦æ°—æŒã¡ã‚ˆã‹ã£ãŸï¼"
      },
      {
        key: "birthday",
        label: "èª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ï¼",
        icon: "ğŸ‚",
        gradient: ["#fae8ff", "#e0f2fe"], // purple -> sky
        accent: "#a855f7",
        defaultMsg: "ãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†ï¼ç´ æ•µãªä¸€å¹´ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ï¼"
      },
      {
        key: "always",
        label: "ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†",
        icon: "ğŸ’–",
        gradient: ["#ffe4e6", "#fff7ed"], // rose -> warm
        accent: "#ec4899",
        defaultMsg: "ã„ã¤ã‚‚æ”¯ãˆã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚ã™ã”ãé ¼ã‚Šã«ã—ã¦ã„ã¾ã™ï¼"
      },
      {
        key: "team",
        label: "ãƒãƒ¼ãƒ æœ€é«˜ï¼",
        icon: "ğŸ¤",
        gradient: ["#dcfce7", "#ecfeff"], // green -> cyan
        accent: "#22c55e",
        defaultMsg: "ã¿ã‚“ãªã®é›°å›²æ°—ã‚’æ˜ã‚‹ãã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼"
      }
    ];

    // ====== Helpers ======
    const $ = (id) => document.getElementById(id);

    function todayJP() {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¥æœ¬æƒ³å®šãªã®ã§æ—¥æœ¬èªè¡¨ç¤º
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}/${mm}/${dd}`;
    }

    function showToast(message, icon = "âœ…") {
      const toast = $("toast");
      $("toastMsg").textContent = message;
      $("toastIcon").textContent = icon;
      toast.classList.remove("hidden");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.add("hidden"), 2200);
    }

    function clampTextToFit(el, minPx, maxPx) {
      // æ–‡å­—æ•°ã«å¿œã˜ã¦è‡ªå‹•èª¿æ•´ï¼šã¾ãšæœ€å¤§â†’æº¢ã‚ŒãŸã‚‰ä¸‹ã’ã‚‹
      // ï¼ˆã‚¹ã‚¯ã‚·ãƒ§/æ›¸ãå‡ºã—æ™‚ã‚‚å®‰å®šï¼‰
      el.style.fontSize = maxPx + "px";
      el.style.lineHeight = "1.6";
      let safety = 40;
      while (safety-- > 0 && el.scrollHeight > el.clientHeight + 2 && maxPx > minPx) {
        maxPx -= 1;
        el.style.fontSize = maxPx + "px";
      }
    }

    function setCardTheme(catKey) {
      const c = CATEGORIES.find(x => x.key === catKey) || CATEGORIES[0];
      const card = $("card");
      const gradient = `linear-gradient(135deg, ${c.gradient[0]}, ${c.gradient[1]})`;
      card.style.background = gradient;

      $("cardIcon").textContent = c.icon;
      $("cardBadge").textContent = c.label;

      // ã•ã‚Šã’ãªããƒãƒƒã‚¸æ ã‚„å½±ã«ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆæ´¾æ‰‹ã™ããªã„ï¼‰
      $("cardBadge").style.boxShadow = `0 10px 20px ${hexToRgba(c.accent, 0.18)}`;
      $("cardBadge").style.borderColor = hexToRgba(c.accent, 0.18);
    }

    function hexToRgba(hex, a) {
      const h = hex.replace("#", "").trim();
      const full = h.length === 3 ? h.split("").map(ch => ch + ch).join("") : h;
      const num = parseInt(full, 16);
      const r = (num >> 16) & 255;
      const g = (num >> 8) & 255;
      const b = num & 255;
      return `rgba(${r},${g},${b},${a})`;
    }

    function sanitizeSingleLine(str) {
      return (str || "").replace(/\s+/g, " ").trim();
    }

    function updatePreview() {
      const to = sanitizeSingleLine($("toName").value);
      const from = sanitizeSingleLine($("fromName").value);
      const msg = ($("message").value || "").trim();
      const cat = $("category").value;

      setCardTheme(cat);

      $("msgCount").textContent = String(msg.length);

      // å®›å/è´ˆã‚Šä¸»ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç”¨æ„
      $("cardTo").textContent = (to ? `${to}ã¸` : "ã€‡ã€‡ã•ã‚“ã¸");
      $("cardFrom").textContent = (from ? `${from}ã‚ˆã‚Š` : "ã€‡ã€‡ã‚ˆã‚Š");

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      $("cardMessage").textContent =
        msg || "ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚çŸ­ãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚ã‚ãªãŸã®ã€Œã‚ã‚ŠãŒã¨ã†ã€ã¯ã€ã¡ã‚ƒã‚“ã¨å±Šãã¾ã™ã€‚";

      $("cardDate").textContent = todayJP();

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé ˜åŸŸã‚’ä¸€å®šã«ã—ã¦ã€æº¢ã‚ŒãŸã‚‰ç¸®å°ï¼ˆè¦‹ãŸç›®ã¨DLå“è³ªã®ä¸¡ç«‹ï¼‰
      const area = $("cardMessage");
      // ä¸€åº¦é«˜ã•ã‚’å›ºå®šï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã§å¤‰ã‚ã‚‹ã®ã§æ¯å›è¨ˆç®—ï¼‰
      // ç›®å®‰: 4ã€œ6è¡Œåˆ†
      const maxLines = window.matchMedia("(min-width: 640px)").matches ? 6 : 5;
      const basePx = window.matchMedia("(min-width: 640px)").matches ? 16 : 15;
      area.style.maxHeight = `calc(${maxLines} * 1.6em)`;
      clampTextToFit(area, 13, basePx);
    }

    function validateForDownload() {
      // ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã ã‘ã€æœ€ä½é™ã®å…¥åŠ›ãƒã‚§ãƒƒã‚¯
      const toEl = $("toName");
      const fromEl = $("fromName");
      const msgEl = $("message");

      [toEl, fromEl, msgEl].forEach(el => el.classList.remove("invalid"));

      const to = sanitizeSingleLine(toEl.value);
      const from = sanitizeSingleLine(fromEl.value);
      const msg = (msgEl.value || "").trim();

      let ok = true;
      if (!to) { toEl.classList.add("invalid"); ok = false; }
      if (!from) { fromEl.classList.add("invalid"); ok = false; }
      if (!msg) { msgEl.classList.add("invalid"); ok = false; }

      if (!ok) {
        showToast("å®›åãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»è´ˆã‚Šä¸»ã‚’å…¥ã‚Œã‚‹ã¨ã€ã‚‚ã£ã¨å¬‰ã—ã„ã‚«ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ï¼", "âš ï¸");
      }
      return ok;
    }

    async function downloadCard() {
      // å…¥åŠ›ãŒç©ºã§ã‚‚å‹•ããŒã€ä¿å­˜ãƒœã‚¿ãƒ³ã ã‘ã¯è»½ãä¿ƒã™
      if (!validateForDownload()) return;

      const card = $("card");
      const note = $("exportNote");

      // æ›¸ãå‡ºã—ç”¨ã«æ³¨è¨˜ã‚’æ¶ˆã™
      note.classList.add("hidden");

      try {
        // iOSå¯¾ç­–å«ã‚ã¦ç™½èƒŒæ™¯ã«è¿‘ã„å½¢ã‚’ä¿ã¤
        const scale = Math.min(3, Math.max(2, (window.devicePixelRatio || 2)));
        const canvas = await html2canvas(card, {
          backgroundColor: null, // èƒŒæ™¯ã¯ã‚«ãƒ¼ãƒ‰è‡ªèº«ã®ã‚°ãƒ©ãƒ‡
          scale,
          useCORS: true,
          logging: false
        });

        const dataUrl = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = dataUrl;

        // ãƒ•ã‚¡ã‚¤ãƒ«åã¯å®‰å…¨ãªã‚‚ã®ã«
        const safeTo = sanitizeSingleLine($("toName").value).replace(/[\\/:*?"<>|]/g, "");
        const stamp = todayJP().replaceAll("/", "");
        a.download = `thanks-card_${safeTo || "card"}_${stamp}.png`;

        document.body.appendChild(a);
        a.click();
        a.remove();

        showToast("ç”»åƒã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ãã®ã¾ã¾LINEã§é€ã‚Œã¾ã™ã€‚", "âœ…");
      } catch (e) {
        console.error(e);
        showToast("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¼ãƒ‰éƒ¨åˆ†ã‚’ã‚¹ã‚¯ã‚·ãƒ§ã—ã¦é€ã£ã¦ãã ã•ã„ğŸ™", "âš ï¸");
      } finally {
        note.classList.remove("hidden");
      }
    }

    function fillExample() {
      $("toName").value = "ä½è—¤ã•ã‚“";
      $("category").value = "help";
      $("message").value = "ãƒ”ãƒ¼ã‚¯ã®æ™‚é–“ã«ãƒ¬ã‚¸ã‚’åŠ©ã‘ã¦ãã‚Œã¦æœ¬å½“ã«åŠ©ã‹ã£ãŸï¼\nãŠã‹ã’ã§å…¨ä½“ãŒã‚¹ãƒ ãƒ¼ã‚ºã«å›ã£ãŸã‚ˆã€‚ã‚ã‚ŠãŒã¨ã†ï¼";
      $("fromName").value = "åº—é•· ç”°ä¸­";
      updatePreview();
      showToast("ä¾‹ã‚’å…¥ã‚Œã¾ã—ãŸã€‚å¥½ãã«ç·¨é›†ã—ã¦OKï¼", "âœ¨");
    }

    function resetAll() {
      $("toName").value = "";
      $("message").value = "";
      $("fromName").value = "";
      $("category").value = CATEGORIES[3].key; // ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†
      updatePreview();
      showToast("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ", "â†º");
    }

    // ====== Init ======
    (function init() {
      // Populate select
      const sel = $("category");
      CATEGORIES.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.key;
        opt.textContent = c.label;
        sel.appendChild(opt);
      });
      sel.value = CATEGORIES[3].key;

      // listeners
      ["toName", "message", "fromName", "category"].forEach(id => {
        $(id).addEventListener("input", updatePreview);
        $(id).addEventListener("change", updatePreview);
      });

      $("btnDownload").addEventListener("click", downloadCard);
      $("btnFillExample").addEventListener("click", fillExample);
      $("btnReset").addEventListener("click", resetAll);

      // ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´æ™‚ï¼šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºãªã‚‰ãŠã™ã™ã‚æ–‡ã‚’å…¥ã‚Œã‚‹ï¼ˆæŠ¼ã—ä»˜ã‘ãªã„ï¼‰
      sel.addEventListener("change", () => {
        const msgEl = $("message");
        const msg = (msgEl.value || "").trim();
        if (!msg) {
          const c = CATEGORIES.find(x => x.key === sel.value);
          msgEl.value = c?.defaultMsg || "";
        }
        updatePreview();
      });

      // åˆå›æç”»
      $("cardDate").textContent = todayJP();
      updatePreview();

      // ãƒªã‚µã‚¤ã‚ºæ™‚ã«æ–‡å­—ã‚µã‚¤ã‚ºå†èª¿æ•´
      window.addEventListener("resize", () => {
        // é€£æ‰“æŠ‘åˆ¶
        clearTimeout(window.__rz);
        window.__rz = setTimeout(updatePreview, 80);
      });
    })();
  </script>
</body>
</html>
